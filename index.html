<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0f0f1e"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Air Time"/>
  <title>Air Time ‚Äî –§–∏–Ω–∞–Ω—Å—ã</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700&family=DM+Sans:wght@400;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#0f0f1e;min-height:100vh;font-family:'DM Sans',sans-serif;}
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:#0f0f1e;}
    ::-webkit-scrollbar-thumb{background:#3a3a5a;border-radius:2px;}
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FIREBASE CONFIG ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
// –ü–æ–ª—É—á–∏—Ç—å: console.firebase.google.com ‚Üí –ø—Ä–æ–µ–∫—Ç ‚Üí Web App ‚Üí Config
// –ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å (–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ª–æ–∫–∞–ª—å–Ω–æ)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyC51J93AA-IDYvab2jzuJjFPxFTO6OD3IE",
  projectId: "airtime-finance",
  appId: "1:897898898287:web:b42c91c339a4ec2fe7be9a",
};

let db = null;
let firebaseReady = false;

async function initFirebase() {
if (!FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "AIzaSyC51J93AA-IDYvab2jzuJjFPxFTO6OD3IE") return false;
  try {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js");
    const { getFirestore, doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js");
    const app = initializeApp(FIREBASE_CONFIG);
    const fs = getFirestore(app);
    db = { fs, doc, getDoc, setDoc };
    firebaseReady = true;
    return true;
  } catch(e) { return false; }
}

async function load(key) {
  if (db) {
    try {
      const snap = await db.getDoc(db.doc(db.fs, "airtime", key));
      return snap.exists() ? snap.data().value : null;
    } catch { return null; }
  }
  return localStorage.getItem("at_" + key);
}

async function save(key, value) {
  if (db) {
    try { await db.setDoc(db.doc(db.fs, "airtime", key), { value }); } catch {}
  } else {
    localStorage.setItem("at_" + key, value);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const { useState, useEffect } = React;

const ACCOUNTS = ["–ü—Ä–æ–¥–∞–∫—à–Ω", "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç", "–ù–∞–ª"];
const INCOME_CATS = ["–°—ä—ë–º–∫–∞", "–ú–æ–Ω—Ç–∞–∂/–ø–æ—Å—Ç–ø—Ä–æ–¥", "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è", "–í–µ–±–∏–Ω–∞—Ä", "–í—ã–µ–∑–¥–Ω–∞—è —Å—ä—ë–º–∫–∞", "AI-–≤–∏–¥–µ–æ", "–ü—Ä–æ—á–∏–π –¥–æ—Ö–æ–¥"];
const EXPENSE_CATS = ["–ö–æ–º–º—É–Ω–∞–ª–∫–∞", "–ó–∞—Ä–ø–ª–∞—Ç–∞", "–ê—Ä–µ–Ω–¥–∞/—Ö–æ–∑", "–†–µ–∫–ª–∞–º–∞", "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "–ü–æ–¥–ø–∏—Å–∫–∏/–ü–û", "–ù–∞–ª–æ–≥–∏/–±—É—Ö–≥–∞–ª—Ç–µ—Ä", "–ü—Ä–æ—á–µ–µ"];
const MONTHS = ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
const ICONS = { "–ü—Ä–æ–¥–∞–∫—à–Ω":"üé¨", "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç":"üéÆ", "–ù–∞–ª":"üíµ" };

const C = {
  bg:"#0f0f1e", card:"#1a1a30", card2:"#222238",
  border:"#2e2e4a", accent:"#7c3aed", al:"#a78bfa",
  green:"#22c55e", red:"#ef4444", amber:"#f59e0b", blue:"#3b82f6",
  text:"#e2e2f0", sub:"#7878a0", muted:"#3a3a5a", white:"#ffffff"
};

const fmt = n => new Intl.NumberFormat("ru-RU").format(Math.round(n||0)) + " —Ä.";

function mKey(d) {
  const dt = new Date(d);
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`;
}
function mLabel(k) {
  const [y,m] = k.split("-");
  return `${MONTHS[parseInt(m)-1]} ${y}`;
}

// UI
const Card = ({children,style={}}) => <div style={{background:C.card,borderRadius:18,padding:16,...style}}>{children}</div>;
const Lbl = ({children}) => <div style={{fontSize:11,color:C.sub,letterSpacing:1.5,textTransform:"uppercase",marginBottom:10}}>{children}</div>;

const ChoiceBtn = ({label,icon,active,onClick,color}) => (
  <button onClick={onClick} style={{
    flex:1,padding:"16px 10px",borderRadius:14,
    border:`2px solid ${active?color:C.border}`,
    background:active?color+"20":C.card2,
    color:active?color:C.sub,cursor:"pointer",
    fontSize:13,fontFamily:"'Unbounded',sans-serif",fontWeight:active?700:400,
    display:"flex",flexDirection:"column",alignItems:"center",gap:8,
    transition:"all .2s",transform:active?"scale(1.04)":"scale(1)",
  }}>
    <span style={{fontSize:26}}>{icon}</span>{label}
  </button>
);

const PillBtn = ({label,active,onClick,color=C.accent}) => (
  <button onClick={onClick} style={{
    padding:"9px 16px",borderRadius:50,
    border:`1.5px solid ${active?color:C.border}`,
    background:active?color:"transparent",
    color:active?C.white:C.sub,cursor:"pointer",
    fontSize:13,fontWeight:active?600:400,
    transition:"all .15s",whiteSpace:"nowrap",
  }}>{label}</button>
);

const Dots = ({total,cur}) => (
  <div style={{display:"flex",gap:6,justifyContent:"center",margin:"8px 0 18px"}}>
    {Array.from({length:total}).map((_,i)=>(
      <div key={i} style={{
        width:i===cur?22:7,height:7,borderRadius:4,
        background:i<cur?C.al:i===cur?C.accent:C.muted,
        transition:"all .3s"
      }}/>
    ))}
  </div>
);

const NumInput = ({value,onChange,placeholder="0",autoFocus=false}) => (
  <div style={{position:"relative"}}>
    <input type="number" placeholder={placeholder} value={value} onChange={onChange} autoFocus={autoFocus} style={{
      width:"100%",boxSizing:"border-box",padding:"16px 52px 16px 16px",
      background:C.card2,border:`2px solid ${C.border}`,
      borderRadius:14,color:C.white,fontSize:30,
      fontFamily:"'Unbounded',sans-serif",outline:"none",
    }}/>
    <span style={{position:"absolute",right:16,top:"50%",transform:"translateY(-50%)",color:C.sub,fontSize:16}}>—Ä.</span>
  </div>
);

const TxtInput = ({value,onChange,placeholder}) => (
  <input type="text" placeholder={placeholder} value={value} onChange={onChange} style={{
    width:"100%",boxSizing:"border-box",padding:"12px 14px",
    background:C.card2,border:`2px solid ${C.border}`,
    borderRadius:12,color:C.white,fontSize:14,outline:"none",
  }}/>
);

// EntryForm
function EntryForm({onSave}) {
  const [step,setStep] = useState(0);
  const [type,setType] = useState(null);
  const [acc,setAcc] = useState(null);
  const [pay,setPay] = useState(null);
  const [cat,setCat] = useState(null);
  const [amt,setAmt] = useState("");
  const [cmt,setCmt] = useState("");
  const [done,setDone] = useState(false);

  const isNal = acc === "–ù–∞–ª";
  // –ï—Å–ª–∏ —Å—á—ë—Ç –ù–∞–ª ‚Äî —à–∞–≥–æ–≤ 4 (–±–µ–∑ –≤—ã–±–æ—Ä–∞ –Ω–∞–ª/–±–µ–∑–Ω–∞–ª), –∏–Ω–∞—á–µ 5
  const STEPS = isNal ? 4 : 5;
  const cats = type==="income"?INCOME_CATS:EXPENSE_CATS;

  // ok[i] ‚Äî –º–æ–∂–Ω–æ –ª–∏ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ –Ω–∞ —à–∞–≥–µ i
  // –®–∞–≥–∏: 0=—Ç–∏–ø, 1=—Å—á—ë—Ç, 2=–Ω–∞–ª/–±–µ–∑–Ω–∞–ª (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ù–∞–ª), 3=–∫–∞—Ç–µ–≥–æ—Ä–∏—è, 4=—Å—É–º–º–∞
  // –ü—Ä–∏ —Å—á—ë—Ç–µ –ù–∞–ª —à–∞–≥–∏: 0=—Ç–∏–ø, 1=—Å—á—ë—Ç, 2=–∫–∞—Ç–µ–≥–æ—Ä–∏—è, 3=—Å—É–º–º–∞
  const effectivePay = isNal ? "cash" : pay;
  const ok = isNal
    ? [!!type, !!acc, !!cat, !!amt&&!isNaN(+amt)&&+amt>0]
    : [!!type, !!acc, !!pay, !!cat, !!amt&&!isNaN(+amt)&&+amt>0];

  function reset(){setStep(0);setType(null);setAcc(null);setPay(null);setCat(null);setAmt("");setCmt("");}

  function submit(){
    if(!ok[STEPS-1])return;
    onSave({id:Date.now(),date:new Date().toISOString(),type,account:acc,payType:effectivePay,category:cat,amount:+amt,comment:cmt});
    setDone(true);
    setTimeout(()=>{setDone(false);reset();},1500);
  }

  // –ü—Ä–∏ —Å–º–µ–Ω–µ —Å—á—ë—Ç–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º pay –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –µ—Å–ª–∏ –Ω–∞–¥–æ
  function chooseAcc(a) {
    setAcc(a);
    setPay(null);
  }

  if(done) return (
    <div style={{textAlign:"center",padding:"72px 0"}}>
      <div style={{fontSize:62,marginBottom:14}}>‚úÖ</div>
      <div style={{color:C.al,fontFamily:"'Unbounded',sans-serif",fontSize:17}}>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>
    </div>
  );

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ
  // –ü—Ä–∏ —Å—á—ë—Ç–µ –ù–∞–ª: 0=—Ç–∏–ø, 1=—Å—á—ë—Ç, 2=–∫–∞—Ç–µ–≥–æ—Ä–∏—è, 3=—Å—É–º–º–∞
  // –ò–Ω–∞—á–µ:         0=—Ç–∏–ø, 1=—Å—á—ë—Ç, 2=–Ω–∞–ª/–±–µ–∑–Ω–∞–ª, 3=–∫–∞—Ç–µ–≥–æ—Ä–∏—è, 4=—Å—É–º–º–∞
  const showPayStep = !isNal && step === 2;
  const showCatStep = isNal ? step === 2 : step === 3;
  const showAmtStep = isNal ? step === 3 : step === 4;

  return (
    <div>
      <Dots total={STEPS} cur={step}/>
      {step===0&&<><Lbl>–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</Lbl><div style={{display:"flex",gap:12}}>
        <ChoiceBtn label="–î–æ—Ö–æ–¥" icon="üìà" active={type==="income"} color={C.green} onClick={()=>setType("income")}/>
        <ChoiceBtn label="–†–∞—Å—Ö–æ–¥" icon="üìâ" active={type==="expense"} color={C.red} onClick={()=>setType("expense")}/>
      </div></>}
      {step===1&&<><Lbl>–°—á—ë—Ç</Lbl><div style={{display:"flex",gap:10}}>
        {ACCOUNTS.map(a=><ChoiceBtn key={a} label={a} icon={ICONS[a]} active={acc===a} color={C.accent} onClick={()=>chooseAcc(a)}/>)}
      </div></>}
      {showPayStep&&<><Lbl>–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã</Lbl><div style={{display:"flex",gap:12}}>
        <ChoiceBtn label="–ù–∞–ª" icon="üíµ" active={pay==="cash"} color={C.amber} onClick={()=>setPay("cash")}/>
        <ChoiceBtn label="–ë–µ–∑–Ω–∞–ª" icon="üí≥" active={pay==="card"} color={C.blue} onClick={()=>setPay("card")}/>
      </div></>}
      {showCatStep&&<><Lbl>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</Lbl><div style={{display:"flex",flexWrap:"wrap",gap:8}}>
        {cats.map(c=><PillBtn key={c} label={c} active={cat===c} onClick={()=>setCat(c)}/>)}
      </div></>}
      {showAmtStep&&<>
        <Lbl>–°—É–º–º–∞</Lbl>
        <NumInput value={amt} onChange={e=>setAmt(e.target.value)} autoFocus={true}/>
        <div style={{marginTop:14,marginBottom:6}}><Lbl>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Lbl></div>
        <TxtInput value={cmt} onChange={e=>setCmt(e.target.value)} placeholder="–ö–ª–∏–µ–Ω—Ç, –æ–ø–∏—Å–∞–Ω–∏–µ..."/>
        <Card style={{marginTop:16,background:C.card2,fontSize:13,color:C.sub,lineHeight:2}}>
          <span style={{color:type==="income"?C.green:C.red,fontWeight:700}}>{type==="income"?"‚ñ≤ –î–æ—Ö–æ–¥":"‚ñº –†–∞—Å—Ö–æ–¥"}</span>
          {"  ¬∑  "}{acc}{!isNal&&("  ¬∑  "+(effectivePay==="cash"?"üíµ –ù–∞–ª":"üí≥ –ë–µ–∑–Ω–∞–ª"))}{"  ¬∑  "}{cat}
        </Card>
      </>}
      <div style={{display:"flex",gap:10,marginTop:22}}>
        {step>0&&<button onClick={()=>setStep(s=>s-1)} style={{padding:"13px 18px",borderRadius:12,border:"none",background:C.card2,color:C.sub,cursor:"pointer",fontSize:14,fontWeight:600}}>‚Üê –ù–∞–∑–∞–¥</button>}
        {step<STEPS-1
          ?<button onClick={()=>ok[step]&&setStep(s=>s+1)} disabled={!ok[step]} style={{flex:1,padding:"13px",borderRadius:12,border:"none",background:ok[step]?C.accent:C.muted,color:C.white,cursor:ok[step]?"pointer":"default",opacity:ok[step]?1:0.45,fontSize:15,fontWeight:700,transition:"all .2s"}}>–î–∞–ª–µ–µ ‚Üí</button>
          :<button onClick={submit} disabled={!ok[STEPS-1]} style={{flex:1,padding:"13px",borderRadius:12,border:"none",background:ok[STEPS-1]?C.green:C.muted,color:C.white,cursor:ok[STEPS-1]?"pointer":"default",opacity:ok[STEPS-1]?1:0.45,fontSize:15,fontWeight:700}}>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        }
      </div>
    </div>
  );
}

// History
function History({entries,onDelete}) {
  const sorted = [...entries].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const byM = {};
  for(const e of sorted){const k=mKey(e.date);if(!byM[k])byM[k]=[];byM[k].push(e);}

  if(!entries.length) return (
    <div style={{textAlign:"center",padding:"60px 0"}}>
      <div style={{fontSize:48,marginBottom:10}}>üì≠</div>
      <div style={{color:C.sub}}>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>
    </div>
  );

  return <div>
    {Object.keys(byM).sort((a,b)=>b.localeCompare(a)).map(month=>{
      const items=byM[month];
      const inc=items.filter(e=>e.type==="income").reduce((s,e)=>s+e.amount,0);
      const exp=items.filter(e=>e.type==="expense").reduce((s,e)=>s+e.amount,0);
      return <div key={month} style={{marginBottom:22}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
          <span style={{fontFamily:"'Unbounded',sans-serif",fontSize:12,color:C.al}}>{mLabel(month)}</span>
          <span style={{fontSize:12}}>
            <span style={{color:C.green}}>+{fmt(inc)}</span>
            <span style={{color:C.muted,margin:"0 5px"}}>¬∑</span>
            <span style={{color:C.red}}>‚àí{fmt(exp)}</span>
          </span>
        </div>
        {items.map(e=>(
          <div key={e.id} style={{display:"flex",alignItems:"center",gap:10,padding:"11px 13px",marginBottom:5,background:C.card,borderRadius:12,borderLeft:`3px solid ${e.type==="income"?C.green:C.red}`}}>
            <span style={{fontSize:18}}>{e.payType==="cash"?"üíµ":"üí≥"}</span>
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontSize:13,color:C.text,fontWeight:600}}>
                {e.category} <span style={{color:C.muted,fontWeight:400}}>¬∑ {e.account}</span>
              </div>
              {e.comment&&<div style={{fontSize:11,color:C.muted,marginTop:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{e.comment}</div>}
            </div>
            <div style={{textAlign:"right"}}>
              <div style={{fontFamily:"'Unbounded',sans-serif",fontSize:12,color:e.type==="income"?C.green:C.red,fontWeight:700}}>
                {e.type==="income"?"+":"‚àí"}{fmt(e.amount)}
              </div>
              <div style={{fontSize:10,color:C.muted,marginTop:2}}>{new Date(e.date).toLocaleDateString("ru-RU")}</div>
            </div>
            <button onClick={()=>onDelete(e.id)} style={{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:15}}>‚úï</button>
          </div>
        ))}
      </div>;
    })}
  </div>;
}

// BalanceCorrection
function BalanceCorrection({overrides,onSave}) {
  const [vals,setVals] = useState(()=>{
    const i={};ACCOUNTS.forEach(a=>{i[a]=overrides[a]!==undefined?String(overrides[a]):"";});return i;
  });
  const [saved,setSaved] = useState(false);

  function submit(){
    const r={};ACCOUNTS.forEach(a=>{if(vals[a]!==""&&!isNaN(+vals[a]))r[a]=+vals[a];});
    onSave(r);setSaved(true);setTimeout(()=>setSaved(false),2000);
  }

  return <div>
    <Card style={{marginBottom:16,background:C.card2}}>
      <div style={{fontSize:13,color:C.sub,lineHeight:1.7}}>
        –í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —Å—á—ë—Ç–µ. –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
      </div>
    </Card>
    {ACCOUNTS.map(a=>(
      <div key={a} style={{marginBottom:18}}>
        <Lbl>{ICONS[a]}  {a}</Lbl>
        <NumInput value={vals[a]} onChange={e=>setVals(v=>({...v,[a]:e.target.value}))} placeholder="–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫"/>
      </div>
    ))}
    <button onClick={submit} style={{width:"100%",padding:"14px",borderRadius:14,border:"none",background:saved?C.green:C.accent,color:C.white,cursor:"pointer",fontSize:15,fontWeight:700,transition:"all .3s"}}>
      {saved?"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!":"üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É"}
    </button>
    {Object.keys(overrides).length>0&&<div style={{marginTop:22}}>
      <Lbl>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏</Lbl>
      {ACCOUNTS.filter(a=>overrides[a]!==undefined).map(a=>(
        <div key={a} style={{display:"flex",justifyContent:"space-between",padding:"11px 0",borderBottom:`1px solid ${C.border}`,fontSize:13}}>
          <span style={{color:C.sub}}>{ICONS[a]}  {a}</span>
          <span style={{color:C.al,fontWeight:600}}>{fmt(overrides[a])}</span>
        </div>
      ))}
      <button onClick={()=>onSave({})} style={{marginTop:14,padding:"10px 16px",borderRadius:10,border:`1px solid ${C.border}`,background:"transparent",color:C.red,cursor:"pointer",fontSize:12}}>
        –°–±—Ä–æ—Å–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
      </button>
    </div>}
  </div>;
}

// Export
function doExport(entries, overrides) {
  const byM={};
  for(const e of entries){const k=mKey(e.date);if(!byM[k])byM[k]={inc:0,exp:0};if(e.type==="income")byM[k].inc+=e.amount;else byM[k].exp+=e.amount;}
  const rows=["–î–ò–ù–ê–ú–ò–ö–ê –ü–û –ú–ï–°–Ø–¶–ê–ú",["–ú–µ—Å—è—Ü","–î–æ—Ö–æ–¥—ã","–†–∞—Å—Ö–æ–¥—ã","–ü—Ä–∏–±—ã–ª—å","–ú–∞—Ä–∂–∞ %"].join(";")];
  let tI=0,tE=0;
  for(const m of Object.keys(byM).sort()){const{inc,exp}=byM[m];tI+=inc;tE+=exp;rows.push([mLabel(m),inc,exp,inc-exp,inc>0?((inc-exp)/inc*100).toFixed(1)+"%":"0%"].join(";"));}
  rows.push(["–ò–¢–û–ì–û",tI,tE,tI-tE,tI>0?((tI-tE)/tI*100).toFixed(1)+"%":"0%"].join(";"));
  rows.push("","–ë–ê–õ–ê–ù–°–´ –ü–û –°–ß–ï–¢–ê–ú",["–°—á—ë—Ç","–û—Å—Ç–∞—Ç–æ–∫","–î–æ—Ö–æ–¥—ã","–†–∞—Å—Ö–æ–¥—ã"].join(";"));
  for(const a of ACCOUNTS){const inc=entries.filter(e=>e.account===a&&e.type==="income").reduce((s,e)=>s+e.amount,0);const exp=entries.filter(e=>e.account===a&&e.type==="expense").reduce((s,e)=>s+e.amount,0);rows.push([a,overrides[a]!==undefined?overrides[a]:(inc-exp),inc,exp].join(";"));}
  rows.push("","–í–°–ï –û–ü–ï–†–ê–¶–ò–ò",["–î–∞—Ç–∞","–¢–∏–ø","–°—á—ë—Ç","–ù–∞–ª/–ë–µ–∑–Ω–∞–ª","–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–°—É–º–º–∞","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"].join(";"));
  for(const e of [...entries].sort((a,b)=>new Date(b.date)-new Date(a.date))){rows.push([new Date(e.date).toLocaleDateString("ru-RU"),e.type==="income"?"–î–æ—Ö–æ–¥":"–†–∞—Å—Ö–æ–¥",e.account,e.payType==="cash"?"–ù–∞–ª":"–ë–µ–∑–Ω–∞–ª",e.category,e.amount,e.comment||""].join(";"));}
  const blob=new Blob(["\uFEFF"+rows.join("\n")],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`airtime_${new Date().toLocaleDateString("ru-RU").replace(/\./g,"-")}.csv`;a.click();URL.revokeObjectURL(url);
}

// Dashboard
function Dashboard({entries,overrides,onExport,sync}) {
  const tI=entries.filter(e=>e.type==="income").reduce((s,e)=>s+e.amount,0);
  const tE=entries.filter(e=>e.type==="expense").reduce((s,e)=>s+e.amount,0);
  const byM={};
  for(const e of entries){const k=mKey(e.date);if(!byM[k])byM[k]={inc:0,exp:0};if(e.type==="income")byM[k].inc+=e.amount;else byM[k].exp+=e.amount;}
  const months=Object.keys(byM).sort().slice(-6);
  const maxV=Math.max(...months.map(m=>Math.max(byM[m].inc,byM[m].exp)),1);

  return <div>
    <div style={{textAlign:"center",marginBottom:10}}>
      <span style={{fontSize:11,color:sync==="cloud"?C.green:C.amber}}>
        {sync==="cloud"?"‚òÅÔ∏è –û–±–ª–∞–∫–æ (Firebase) ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞":"üíæ –õ–æ–∫–∞–ª—å–Ω–æ ‚Äî –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ"}
      </span>
    </div>

    <div style={{textAlign:"center",padding:"6px 0 18px"}}>
      <div style={{fontSize:11,color:C.sub,letterSpacing:2,textTransform:"uppercase",marginBottom:4}}>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
      <div style={{fontFamily:"'Unbounded',sans-serif",fontSize:34,color:tI-tE>=0?C.green:C.red,fontWeight:700}}>
        {tI-tE>=0?"+":""}{fmt(tI-tE)}
      </div>
      <div style={{display:"flex",justifyContent:"center",gap:18,marginTop:8,fontSize:13}}>
        <span style={{color:C.green}}>‚Üë {fmt(tI)}</span>
        <span style={{color:C.red}}>‚Üì {fmt(tE)}</span>
      </div>
    </div>

    <div style={{display:"flex",gap:8,marginBottom:16}}>
      {ACCOUNTS.map(a=>{
        const inc=entries.filter(e=>e.account===a&&e.type==="income").reduce((s,e)=>s+e.amount,0);
        const exp=entries.filter(e=>e.account===a&&e.type==="expense").reduce((s,e)=>s+e.amount,0);
        const ov=overrides[a];const d=ov!==undefined?ov:(inc-exp);
        return <Card key={a} style={{flex:1,background:C.card2,padding:"12px 10px",textAlign:"center"}}>
          <div style={{fontSize:18,marginBottom:4}}>{ICONS[a]}</div>
          <div style={{fontSize:10,color:C.sub,marginBottom:4}}>{a}</div>
          <div style={{fontFamily:"'Unbounded',sans-serif",fontSize:12,color:d>=0?C.al:C.red,fontWeight:700,lineHeight:1.3}}>{fmt(d)}</div>
          {ov!==undefined&&<div style={{fontSize:9,color:C.amber,marginTop:3}}>‚ú± —Å–∫–æ—Ä—Ä.</div>}
        </Card>;
      })}
    </div>

    {months.length>0&&<Card style={{marginBottom:14}}>
      <div style={{fontSize:11,color:C.sub,letterSpacing:1,textTransform:"uppercase",marginBottom:14}}>–î–∏–Ω–∞–º–∏–∫–∞</div>
      <div style={{display:"flex",alignItems:"flex-end",gap:6,height:90}}>
        {months.map(m=>{
          const{inc,exp}=byM[m];
          return <div key={m} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center"}}>
            <div style={{display:"flex",gap:3,alignItems:"flex-end",height:82}}>
              <div style={{width:10,height:Math.max(Math.round((inc/maxV)*80),2),background:C.green,borderRadius:"3px 3px 0 0",opacity:.85}}/>
              <div style={{width:10,height:Math.max(Math.round((exp/maxV)*80),2),background:C.red,borderRadius:"3px 3px 0 0",opacity:.85}}/>
            </div>
            <div style={{fontSize:9,color:C.sub,marginTop:4}}>{mLabel(m).slice(0,3)}</div>
          </div>;
        })}
      </div>
      <div style={{display:"flex",gap:14,marginTop:8,fontSize:11,color:C.sub}}>
        <span><span style={{color:C.green}}>‚ñ†</span> –î–æ—Ö–æ–¥</span>
        <span><span style={{color:C.red}}>‚ñ†</span> –†–∞—Å—Ö–æ–¥</span>
      </div>
    </Card>}

    {Object.keys(byM).length>0&&<Card style={{marginBottom:14}}>
      <div style={{fontSize:11,color:C.sub,letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>–ü–æ –º–µ—Å—è—Ü–∞–º</div>
      {Object.keys(byM).sort((a,b)=>b.localeCompare(a)).map(m=>{
        const{inc,exp}=byM[m];const p=inc-exp;
        return <div key={m} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 0",borderBottom:`1px solid ${C.border}`}}>
          <span style={{fontSize:13,color:C.text}}>{mLabel(m)}</span>
          <div style={{textAlign:"right"}}>
            <div style={{fontSize:12,color:p>=0?C.green:C.red,fontWeight:700}}>{p>=0?"+":""}{fmt(p)}</div>
            <div style={{fontSize:10,color:C.sub}}>‚Üë{fmt(inc)} ‚Üì{fmt(exp)}</div>
          </div>
        </div>;
      })}
    </Card>}

    <button onClick={onExport} style={{width:"100%",padding:"14px",borderRadius:14,border:`1.5px solid ${C.border}`,background:"transparent",color:C.al,cursor:"pointer",fontSize:14,fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>
      <span>üì•</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (CSV)
    </button>
  </div>;
}

// App
function App() {
  const [tab,setTab] = useState("add");
  const [entries,setEntries] = useState([]);
  const [overrides,setOverrides] = useState({});
  const [loading,setLoading] = useState(true);
  const [sync,setSync] = useState("local");

  useEffect(()=>{
    async function init(){
      const ok=await initFirebase();
      setSync(ok?"cloud":"local");
      try{const r=await load("entries");if(r)setEntries(JSON.parse(r));}catch(_){}
      try{const r=await load("balances");if(r)setOverrides(JSON.parse(r));}catch(_){}
      setLoading(false);
    }
    init();
  },[]);

  async function saveEntries(next){setEntries(next);await save("entries",JSON.stringify(next));}
  async function saveOverrides(next){setOverrides(next);await save("balances",JSON.stringify(next));}

  const tabs=[
    {id:"add",icon:"Ôºã",label:"–í–Ω–µ—Å—Ç–∏"},
    {id:"history",icon:"‚ò∞",label:"–ò—Å—Ç–æ—Ä–∏—è"},
    {id:"balances",icon:"‚öñ",label:"–ë–∞–ª–∞–Ω—Å"},
    {id:"dashboard",icon:"‚óà",label:"–ò—Ç–æ–≥–∏"},
  ];

  return <>
    <div style={{maxWidth:430,margin:"0 auto",minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}}>
      <div style={{padding:"18px 18px 12px",background:"linear-gradient(180deg,#16163a 0%,#0f0f1e 100%)",borderBottom:`1px solid ${C.border}`}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div>
            <div style={{fontFamily:"'Unbounded',sans-serif",fontSize:17,color:C.text,fontWeight:700,letterSpacing:-0.5}}>Air Time</div>
            <div style={{fontSize:10,color:C.muted,letterSpacing:1.5,textTransform:"uppercase"}}>—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä</div>
          </div>
          <div style={{width:38,height:38,borderRadius:11,background:"#7c3aed25",border:"1px solid #7c3aed44",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}}>üé¨</div>
        </div>
      </div>

      <div style={{flex:1,padding:"18px 16px 84px",overflowY:"auto"}}>
        {loading
          ?<div style={{textAlign:"center",padding:"80px 0",color:C.sub}}>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          :<>
            {tab==="add"&&<EntryForm onSave={e=>saveEntries([...entries,e])}/>}
            {tab==="history"&&<History entries={entries} onDelete={id=>saveEntries(entries.filter(e=>e.id!==id))}/>}
            {tab==="balances"&&<BalanceCorrection overrides={overrides} onSave={saveOverrides}/>}
            {tab==="dashboard"&&<Dashboard entries={entries} overrides={overrides} onExport={()=>doExport(entries,overrides)} sync={sync}/>}
          </>
        }
      </div>

      <div style={{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:"100%",maxWidth:430,background:"#14143a",borderTop:`1px solid ${C.border}`,display:"flex",padding:"8px 0 14px"}}>
        {tabs.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)} style={{flex:1,background:"none",border:"none",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"5px 0"}}>
            <span style={{fontSize:19,filter:tab===t.id?"none":"grayscale(1)",opacity:tab===t.id?1:0.35,transition:"all .2s"}}>{t.icon}</span>
            <span style={{fontSize:10,color:tab===t.id?C.al:C.muted,fontWeight:tab===t.id?600:400}}>{t.label}</span>
          </button>
        ))}
      </div>
    </div>
  </>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
