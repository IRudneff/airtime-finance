<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0f0f1e"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Air Time"/>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link rel="manifest" href="manifest.json"/>
  <title>Air Time ‚Äî –§–∏–Ω–∞–Ω—Å—ã</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700&family=DM+Sans:wght@400;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:#0f0f1e;min-height:100vh;font-family:'DM Sans',sans-serif;}
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:#0f0f1e;}
    ::-webkit-scrollbar-thumb{background:#3a3a5a;border-radius:2px;}
    @keyframes syncPulse{0%,100%{opacity:1}50%{opacity:.5}}
    @keyframes slideUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
    .sync-pulse{animation:syncPulse 1.5s ease-in-out infinite}
    .slide-up{animation:slideUp .3s ease-out}
    .fade-in{animation:fadeIn .4s ease-out}
  </style>
</head>
<body>
  <div id="root"><div style="text-align:center;padding:80px 20px;color:#7878a0">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>

  <!-- Firebase compat SDK ‚Äî –æ–±—ã—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã, –Ω–∏–∫–∞–∫–∏—Ö import() -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- ExcelJS –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ .xlsx —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>

  <script>
// ‚îÄ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ
var db = null;
var firebaseReady = false;

try {
  firebase.initializeApp({
    apiKey: "AIzaSyC51J93AA-IDYvab2jzuJjFPxFTO6OD3IE",
    authDomain: "airtime-finance.firebaseapp.com",
    projectId: "airtime-finance",
    storageBucket: "airtime-finance.firebasestorage.app",
    messagingSenderId: "897898898287",
    appId: "1:897898898287:web:b42c91c339a4ec2fe7be9a",
  });
  db = firebase.firestore();
  firebaseReady = true;
  console.log("Firebase connected");
} catch(e) {
  console.error("Firebase init error:", e);
}

function subscribeDoc(key, callback) {
  if (!db) return null;
  return db.collection("airtime").doc(key).onSnapshot(function(snap) {
    if (snap.exists) callback(snap.data().value);
  }, function(err) { console.error("Snapshot error:", key, err); });
}

function saveDoc(key, value) {
  if (db) return db.collection("airtime").doc(key).set({ value: value });
  localStorage.setItem("at_" + key, value);
  return Promise.resolve();
}

function loadDoc(key) {
  if (db) return db.collection("airtime").doc(key).get().then(function(snap) { return snap.exists ? snap.data().value : null; });
  return Promise.resolve(localStorage.getItem("at_" + key));
}

// ‚îÄ‚îÄ‚îÄ TELEGRAM –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ‚îÄ‚îÄ‚îÄ
// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò —ç—Ç–∏ –¥–≤–∞ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å–≤–æ–∏:
var TG_BOT_TOKEN = "–°–Æ–î–ê_–í–°–¢–ê–í–¨_–¢–û–ö–ï–ù_–ë–û–¢–ê";
var TG_CHAT_ID   = "–°–Æ–î–ê_–í–°–¢–ê–í–¨_CHAT_ID";

function sendTelegramNotify(entry, allEntries, overrides) {
  var isIncome = entry.type === "income";
  var icon = isIncome ? "üí∞" : "üí∏";
  var label = isIncome ? "–î–æ—Ö–æ–¥" : "–†–∞—Å—Ö–æ–¥";
  var sign = isIncome ? "+" : "‚àí";
  var fmtN = function(n){return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0);};
  var amount = fmtN(entry.amount) + " —Ä.";

  // –°—á–∏—Ç–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å)
  var all = allEntries.concat([entry]);
  var balLines = ACCOUNTS.map(function(a){
    var inc = all.filter(function(e){return e.account===a&&e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
    var exp = all.filter(function(e){return e.account===a&&e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
    var bal = overrides[a] !== undefined ? overrides[a] : (inc - exp);
    return ICONS[a] + " " + a + ": *" + fmtN(bal) + " —Ä.*";
  });

  var text = icon + " *" + label + ":* " + sign + amount +
    "\nüìÇ " + entry.category +
    "\nüè¶ " + entry.account + " ¬∑ " + (entry.payType === "cash" ? "üíµ –ù–∞–ª" : "üí≥ –ë–µ–∑–Ω–∞–ª") +
    (entry.comment ? "\nüí¨ " + entry.comment : "") +
    "\nüìÖ " + new Date(entry.date).toLocaleDateString("ru-RU") +
    "\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" +
    "\nüìä *–û—Å—Ç–∞—Ç–∫–∏ –ø–æ —Å—á–µ—Ç–∞–º:*" +
    "\n" + balLines.join("\n");

  fetch("https://api.telegram.org/bot" + TG_BOT_TOKEN + "/sendMessage", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ chat_id: TG_CHAT_ID, text: text, parse_mode: "Markdown" })
  }).catch(function(err) { console.error("Telegram error:", err); });
}

// ‚îÄ‚îÄ‚îÄ REACT APP (pure createElement, no JSX, no Babel) ‚îÄ‚îÄ‚îÄ
var h = React.createElement;
var useState = React.useState;
var useEffect = React.useEffect;
var useRef = React.useRef;

var ACCOUNTS = ["–ü—Ä–æ–¥–∞–∫—à–Ω", "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç", "–ù–∞–ª"];
var INCOME_CATS = ["–°—ä—ë–º–∫–∞", "–ú–æ–Ω—Ç–∞–∂/–ø–æ—Å—Ç–ø—Ä–æ–¥", "–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è", "–í–µ–±–∏–Ω–∞—Ä", "–í—ã–µ–∑–¥–Ω–∞—è —Å—ä—ë–º–∫–∞", "AI-–≤–∏–¥–µ–æ", "–ü—Ä–æ—á–∏–π –¥–æ—Ö–æ–¥"];
var EXPENSE_CATS = ["–ö–æ–º–º—É–Ω–∞–ª–∫–∞", "–ó–∞—Ä–ø–ª–∞—Ç–∞", "–ê—Ä–µ–Ω–¥–∞/—Ö–æ–∑", "–†–µ–∫–ª–∞–º–∞", "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "–ü–æ–¥–ø–∏—Å–∫–∏/–ü–û", "–ù–∞–ª–æ–≥–∏/–±—É—Ö–≥–∞–ª—Ç–µ—Ä", "–ü—Ä–æ—á–µ–µ"];
var MONTHS = ["–Ø–Ω–≤","–§–µ–≤","–ú–∞—Ä","–ê–ø—Ä","–ú–∞–π","–ò—é–Ω","–ò—é–ª","–ê–≤–≥","–°–µ–Ω","–û–∫—Ç","–ù–æ—è","–î–µ–∫"];
var ICONS = { "–ü—Ä–æ–¥–∞–∫—à–Ω":"üé¨", "–ö–∏–±–µ—Ä—Å–ø–æ—Ä—Ç":"üéÆ", "–ù–∞–ª":"üíµ" };
var C = { bg:"#0f0f1e",card:"#1a1a30",card2:"#222238",border:"#2e2e4a",accent:"#7c3aed",al:"#a78bfa",green:"#22c55e",red:"#ef4444",amber:"#f59e0b",blue:"#3b82f6",text:"#e2e2f0",sub:"#7878a0",muted:"#3a3a5a",white:"#ffffff" };

function fmt(n){return new Intl.NumberFormat("ru-RU").format(Math.round(n||0))+" —Ä.";}
function mKey(d){var dt=new Date(d);return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,"0");}
function mLabel(k){var p=k.split("-");return MONTHS[parseInt(p[1])-1]+" "+p[0];}
function O(){var r={};for(var i=0;i<arguments.length;i++){var o=arguments[i];if(o)for(var k in o)r[k]=o[k];}return r;}

function Card(p){return h("div",{className:p.className||"",style:O({background:C.card,borderRadius:18,padding:16},p.style)},p.children);}
function Lbl(p){return h("div",{style:{fontSize:11,color:C.sub,letterSpacing:1.5,textTransform:"uppercase",marginBottom:10}},p.children);}
function ChoiceBtn(p){var a=p.active,c=p.color;return h("button",{onClick:p.onClick,style:{flex:1,padding:"16px 10px",borderRadius:14,border:"2px solid "+(a?c:C.border),background:a?c+"20":C.card2,color:a?c:C.sub,cursor:"pointer",fontSize:13,fontFamily:"'Unbounded',sans-serif",fontWeight:a?700:400,display:"flex",flexDirection:"column",alignItems:"center",gap:8,transition:"all .2s",transform:a?"scale(1.04)":"scale(1)"}},h("span",{style:{fontSize:26}},p.icon),p.label);}
function PillBtn(p){var a=p.active,c=p.color||C.accent;return h("button",{onClick:p.onClick,style:{padding:"9px 16px",borderRadius:50,border:"1.5px solid "+(a?c:C.border),background:a?c:"transparent",color:a?C.white:C.sub,cursor:"pointer",fontSize:13,fontWeight:a?600:400,transition:"all .15s",whiteSpace:"nowrap"}},p.label);}
function Dots(p){return h("div",{style:{display:"flex",gap:6,justifyContent:"center",margin:"8px 0 18px"}},Array.from({length:p.total}).map(function(_,i){return h("div",{key:i,style:{width:i===p.cur?22:7,height:7,borderRadius:4,background:i<p.cur?C.al:i===p.cur?C.accent:C.muted,transition:"all .3s"}});}));}
function NumInput(p){return h("div",{style:{position:"relative"}},h("input",{type:"number",placeholder:p.placeholder||"0",value:p.value,onChange:p.onChange,autoFocus:p.autoFocus||false,style:{width:"100%",boxSizing:"border-box",padding:"16px 52px 16px 16px",background:C.card2,border:"2px solid "+C.border,borderRadius:14,color:C.white,fontSize:30,fontFamily:"'Unbounded',sans-serif",outline:"none"}}),h("span",{style:{position:"absolute",right:16,top:"50%",transform:"translateY(-50%)",color:C.sub,fontSize:16}},"—Ä."));}
function TxtInput(p){return h("input",{type:"text",placeholder:p.placeholder,value:p.value,onChange:p.onChange,style:{width:"100%",boxSizing:"border-box",padding:"12px 14px",background:C.card2,border:"2px solid "+C.border,borderRadius:12,color:C.white,fontSize:14,outline:"none"}});}

function SyncBadge(p){
  var ic=p.sync==="cloud";
  return h("div",{style:{textAlign:"center",marginBottom:10}},
    h("span",{style:{display:"inline-flex",alignItems:"center",gap:6,fontSize:11,color:ic?C.green:C.amber,padding:"4px 12px",borderRadius:20,background:ic?"#22c55e12":"#f59e0b12",border:"1px solid "+(ic?"#22c55e30":"#f59e0b30")}},
      h("span",{className:ic?"sync-pulse":""},ic?"‚òÅÔ∏è":"üíæ"),ic?"–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞":"–õ–æ–∫–∞–ª—å–Ω–æ"),
    p.lastSync&&ic?h("div",{style:{fontSize:9,color:C.muted,marginTop:4}},"–û–±–Ω–æ–≤–ª–µ–Ω–æ: "+p.lastSync):null);
}

// ‚îÄ‚îÄ EntryForm ‚îÄ‚îÄ
function EntryForm(p){
  var _s=useState(0),step=_s[0],setStep=_s[1];
  var _t=useState(null),type=_t[0],setType=_t[1];
  var _a=useState(null),acc=_a[0],setAcc=_a[1];
  var _p=useState(null),pay=_p[0],setPay=_p[1];
  var _c=useState(null),cat=_c[0],setCat=_c[1];
  var _m=useState(""),amt=_m[0],setAmt=_m[1];
  var _cm=useState(""),cmt=_cm[0],setCmt=_cm[1];
  var _d=useState(false),done=_d[0],setDone=_d[1];
  var _sv=useState(false),saving=_sv[0],setSaving=_sv[1];

  var isNal=acc==="–ù–∞–ª", STEPS=isNal?4:5, cats=type==="income"?INCOME_CATS:EXPENSE_CATS;
  var ePay=isNal?"cash":pay;
  var ok=isNal?[!!type,!!acc,!!cat,!!amt&&!isNaN(+amt)&&+amt>0]:[!!type,!!acc,!!pay,!!cat,!!amt&&!isNaN(+amt)&&+amt>0];

  function reset(){setStep(0);setType(null);setAcc(null);setPay(null);setCat(null);setAmt("");setCmt("");}
  function submit(){
    if(!ok[STEPS-1]||saving)return;
    setSaving(true);
    p.onSave({id:Date.now(),date:new Date().toISOString(),type:type,account:acc,payType:ePay,category:cat,amount:+amt,comment:cmt}).then(function(){
      setSaving(false);setDone(true);setTimeout(function(){setDone(false);reset();},1500);
    });
  }

  if(done)return h("div",{className:"fade-in",style:{textAlign:"center",padding:"72px 0"}},h("div",{style:{fontSize:62,marginBottom:14}},"‚úÖ"),h("div",{style:{color:C.al,fontFamily:"'Unbounded',sans-serif",fontSize:17}},"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"),h("div",{style:{color:C.sub,fontSize:12,marginTop:6}},"–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"));

  var sPay=!isNal&&step===2, sCat=isNal?step===2:step===3, sAmt=isNal?step===3:step===4;
  var ct=[];

  if(step===0)ct.push(h(Lbl,{key:"l"},"–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏"),h("div",{key:"c",style:{display:"flex",gap:12}},h(ChoiceBtn,{label:"–î–æ—Ö–æ–¥",icon:"üìà",active:type==="income",color:C.green,onClick:function(){setType("income")}}),h(ChoiceBtn,{label:"–†–∞—Å—Ö–æ–¥",icon:"üìâ",active:type==="expense",color:C.red,onClick:function(){setType("expense")}})));
  if(step===1)ct.push(h(Lbl,{key:"l"},"–°—á—ë—Ç"),h("div",{key:"c",style:{display:"flex",gap:10}},ACCOUNTS.map(function(a){return h(ChoiceBtn,{key:a,label:a,icon:ICONS[a],active:acc===a,color:C.accent,onClick:function(){setAcc(a);setPay(null);}});})));
  if(sPay)ct.push(h(Lbl,{key:"l"},"–§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã"),h("div",{key:"c",style:{display:"flex",gap:12}},h(ChoiceBtn,{label:"–ù–∞–ª",icon:"üíµ",active:pay==="cash",color:C.amber,onClick:function(){setPay("cash")}}),h(ChoiceBtn,{label:"–ë–µ–∑–Ω–∞–ª",icon:"üí≥",active:pay==="card",color:C.blue,onClick:function(){setPay("card")}})));
  if(sCat)ct.push(h(Lbl,{key:"l"},"–ö–∞—Ç–µ–≥–æ—Ä–∏—è"),h("div",{key:"c",style:{display:"flex",flexWrap:"wrap",gap:8}},cats.map(function(c){return h(PillBtn,{key:c,label:c,active:cat===c,onClick:function(){setCat(c)}});})));
  if(sAmt)ct.push(h(Lbl,{key:"l1"},"–°—É–º–º–∞"),h(NumInput,{key:"ni",value:amt,onChange:function(e){setAmt(e.target.value)},autoFocus:true}),h("div",{key:"sp",style:{marginTop:14,marginBottom:6}},h(Lbl,null,"–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)")),h(TxtInput,{key:"ti",value:cmt,onChange:function(e){setCmt(e.target.value)},placeholder:"–ö–ª–∏–µ–Ω—Ç, –æ–ø–∏—Å–∞–Ω–∏–µ..."}),h(Card,{key:"sum",style:{marginTop:16,background:C.card2,fontSize:13,color:C.sub,lineHeight:2}},h("span",{style:{color:type==="income"?C.green:C.red,fontWeight:700}},type==="income"?"‚ñ≤ –î–æ—Ö–æ–¥":"‚ñº –†–∞—Å—Ö–æ–¥"),"  ¬∑  ",acc,!isNal?"  ¬∑  "+(ePay==="cash"?"üíµ –ù–∞–ª":"üí≥ –ë–µ–∑–Ω–∞–ª"):"","  ¬∑  ",cat));

  var bt=[];
  if(step>0)bt.push(h("button",{key:"b",onClick:function(){setStep(step-1)},style:{padding:"13px 18px",borderRadius:12,border:"none",background:C.card2,color:C.sub,cursor:"pointer",fontSize:14,fontWeight:600}},"‚Üê –ù–∞–∑–∞–¥"));
  if(step<STEPS-1)bt.push(h("button",{key:"n",onClick:function(){if(ok[step])setStep(step+1)},disabled:!ok[step],style:{flex:1,padding:"13px",borderRadius:12,border:"none",background:ok[step]?C.accent:C.muted,color:C.white,cursor:ok[step]?"pointer":"default",opacity:ok[step]?1:.45,fontSize:15,fontWeight:700,transition:"all .2s"}},"–î–∞–ª–µ–µ ‚Üí"));
  else bt.push(h("button",{key:"s",onClick:submit,disabled:!ok[STEPS-1]||saving,style:{flex:1,padding:"13px",borderRadius:12,border:"none",background:ok[STEPS-1]?C.green:C.muted,color:C.white,cursor:ok[STEPS-1]?"pointer":"default",opacity:ok[STEPS-1]?1:.45,fontSize:15,fontWeight:700}},saving?"‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é...":"üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"));

  return h("div",{className:"slide-up"},h(Dots,{total:STEPS,cur:step}),ct,h("div",{style:{display:"flex",gap:10,marginTop:22}},bt));
}

// ‚îÄ‚îÄ History ‚îÄ‚îÄ
function History(p){
  var _d=useState(null),deleting=_d[0],setDeleting=_d[1];
  var entries=p.entries;
  var sorted=entries.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date);});
  var byM={};sorted.forEach(function(e){var k=mKey(e.date);if(!byM[k])byM[k]=[];byM[k].push(e);});

  function handleDel(id){setDeleting(id);p.onDelete(id).then(function(){setDeleting(null);});}

  if(!entries.length)return h("div",{style:{textAlign:"center",padding:"60px 0"}},h("div",{style:{fontSize:48,marginBottom:10}},"üì≠"),h("div",{style:{color:C.sub}},"–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π"));

  return h("div",null,
    h("div",{style:{fontSize:11,color:C.muted,textAlign:"center",marginBottom:14}},"–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: "+entries.length),
    Object.keys(byM).sort(function(a,b){return b.localeCompare(a);}).map(function(month){
      var items=byM[month];
      var inc=items.filter(function(e){return e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
      var exp=items.filter(function(e){return e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
      return h("div",{key:month,style:{marginBottom:22}},
        h("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},
          h("span",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:12,color:C.al}},mLabel(month)),
          h("span",{style:{fontSize:12}},h("span",{style:{color:C.green}},"+"+fmt(inc)),h("span",{style:{color:C.muted,margin:"0 5px"}},"¬∑"),h("span",{style:{color:C.red}},"‚àí"+fmt(exp)))),
        items.map(function(e){
          return h("div",{key:e.id,style:{display:"flex",alignItems:"center",gap:10,padding:"11px 13px",marginBottom:5,background:C.card,borderRadius:12,borderLeft:"3px solid "+(e.type==="income"?C.green:C.red),opacity:deleting===e.id?.4:1,transition:"opacity .3s"}},
            h("span",{style:{fontSize:18}},e.payType==="cash"?"üíµ":"üí≥"),
            h("div",{style:{flex:1,minWidth:0}},h("div",{style:{fontSize:13,color:C.text,fontWeight:600}},e.category," ",h("span",{style:{color:C.muted,fontWeight:400}},"¬∑ "+e.account)),e.comment?h("div",{style:{fontSize:11,color:C.muted,marginTop:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},e.comment):null),
            h("div",{style:{textAlign:"right"}},h("div",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:12,color:e.type==="income"?C.green:C.red,fontWeight:700}},(e.type==="income"?"+":"‚àí")+fmt(e.amount)),h("div",{style:{fontSize:10,color:C.muted,marginTop:2}},new Date(e.date).toLocaleDateString("ru-RU"))),
            h("button",{onClick:function(){handleDel(e.id)},disabled:deleting===e.id,style:{background:"none",border:"none",color:C.muted,cursor:"pointer",fontSize:15}},"‚úï"));
        }));
    }));
}

// ‚îÄ‚îÄ BalanceCorrection ‚îÄ‚îÄ
function BalanceCorrection(p){
  var ov=p.overrides;
  function iv(){var i={};ACCOUNTS.forEach(function(a){i[a]=ov[a]!==undefined?String(ov[a]):"";});return i;}
  var _v=useState(iv),vals=_v[0],setVals=_v[1];
  var _s=useState(false),saved=_s[0],setSaved=_s[1];
  useEffect(function(){setVals(iv());},[ov]);

  function submit(){
    var r={};ACCOUNTS.forEach(function(a){if(vals[a]!==""&&!isNaN(+vals[a]))r[a]=+vals[a];});
    p.onSave(r).then(function(){setSaved(true);setTimeout(function(){setSaved(false);},2000);});
  }

  return h("div",null,
    h(Card,{style:{marginBottom:16,background:C.card2}},h("div",{style:{fontSize:13,color:C.sub,lineHeight:1.7}},"–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —Å—á—ë—Ç–µ. –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.")),
    ACCOUNTS.map(function(a){return h("div",{key:a,style:{marginBottom:18}},h(Lbl,null,ICONS[a]+"  "+a),h(NumInput,{value:vals[a],onChange:function(e){var nv=O({},vals);nv[a]=e.target.value;setVals(nv);},placeholder:"–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫"}));}),
    h("button",{onClick:submit,style:{width:"100%",padding:"14px",borderRadius:14,border:"none",background:saved?C.green:C.accent,color:C.white,cursor:"pointer",fontSize:15,fontWeight:700,transition:"all .3s"}},saved?"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!":"üíæ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É"),
    Object.keys(ov).length>0?h("div",{style:{marginTop:22}},
      h(Lbl,null,"–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏"),
      ACCOUNTS.filter(function(a){return ov[a]!==undefined}).map(function(a){return h("div",{key:a,style:{display:"flex",justifyContent:"space-between",padding:"11px 0",borderBottom:"1px solid "+C.border,fontSize:13}},h("span",{style:{color:C.sub}},ICONS[a]+"  "+a),h("span",{style:{color:C.al,fontWeight:600}},fmt(ov[a])));}),
      h("button",{onClick:function(){p.onSave({})},style:{marginTop:14,padding:"10px 16px",borderRadius:10,border:"1px solid "+C.border,background:"transparent",color:C.red,cursor:"pointer",fontSize:12}},"–°–±—Ä–æ—Å–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏")
    ):null);
}

// ‚îÄ‚îÄ Export XLSX with charts ‚îÄ‚îÄ
function doExport(entries,overrides){
  var wb = new ExcelJS.Workbook();
  wb.creator = "Air Time Finance";

  // –¶–≤–µ—Ç–∞
  var purple = "7C3AED", darkBg = "0F0F1E", cardBg = "1A1A30", greenC = "22C55E", redC = "EF4444", amberC = "F59E0B", textC = "E2E2F0", subC = "7878A0", headerBg = "2E2E4A";

  function styleHeader(row) {
    row.eachCell(function(cell){
      cell.fill = {type:"pattern",pattern:"solid",fgColor:{argb:purple}};
      cell.font = {bold:true,color:{argb:"FFFFFF"},size:11};
      cell.alignment = {horizontal:"center",vertical:"middle"};
      cell.border = {bottom:{style:"thin",color:{argb:"FFFFFF"}}};
    });
    row.height = 28;
  }
  function styleCell(cell, isNumber, color) {
    cell.font = {color:{argb:color||textC},size:10};
    cell.alignment = {horizontal:isNumber?"right":"left",vertical:"middle"};
  }

  // ‚îÄ‚îÄ‚îÄ –õ–∏—Å—Ç 1: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º ‚îÄ‚îÄ‚îÄ
  var ws1 = wb.addWorksheet("–î–∏–Ω–∞–º–∏–∫–∞", {properties:{tabColor:{argb:purple}}});
  ws1.properties.defaultRowHeight = 22;

  var byM={};entries.forEach(function(e){var k=mKey(e.date);if(!byM[k])byM[k]={inc:0,exp:0};if(e.type==="income")byM[k].inc+=e.amount;else byM[k].exp+=e.amount;});
  var months=Object.keys(byM).sort();

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  ws1.mergeCells("A1:E1");
  var titleCell = ws1.getCell("A1");
  titleCell.value = "üìä AIR TIME ‚Äî –î–ò–ù–ê–ú–ò–ö–ê –ü–û –ú–ï–°–Ø–¶–ê–ú";
  titleCell.font = {bold:true,size:14,color:{argb:purple}};
  titleCell.alignment = {horizontal:"center"};
  ws1.getRow(1).height = 36;

  ws1.columns = [{width:16},{width:16},{width:16},{width:16},{width:12}];

  var hRow = ws1.addRow(["–ú–µ—Å—è—Ü","–î–æ—Ö–æ–¥—ã","–†–∞—Å—Ö–æ–¥—ã","–ü—Ä–∏–±—ã–ª—å","–ú–∞—Ä–∂–∞ %"]);
  styleHeader(hRow);

  var tI=0,tE=0,dataStartRow=3;
  months.forEach(function(m){
    var d=byM[m]; tI+=d.inc; tE+=d.exp;
    var pr=d.inc-d.exp;
    var margin=d.inc>0?((pr/d.inc)*100).toFixed(1)+"%":"0%";
    var row=ws1.addRow([mLabel(m),d.inc,d.exp,pr,margin]);
    styleCell(row.getCell(1),false);
    styleCell(row.getCell(2),true,greenC);
    styleCell(row.getCell(3),true,redC);
    styleCell(row.getCell(4),true,pr>=0?greenC:redC);
    styleCell(row.getCell(5),true,amberC);
    row.getCell(2).numFmt="#,##0";
    row.getCell(3).numFmt="#,##0";
    row.getCell(4).numFmt="#,##0";
  });

  // –ò—Ç–æ–≥–æ
  var totRow=ws1.addRow(["–ò–¢–û–ì–û",tI,tE,tI-tE,tI>0?((tI-tE)/tI*100).toFixed(1)+"%":"0%"]);
  totRow.eachCell(function(cell){cell.font={bold:true,color:{argb:purple},size:11};cell.border={top:{style:"double",color:{argb:purple}}};});
  totRow.getCell(2).numFmt="#,##0";
  totRow.getCell(3).numFmt="#,##0";
  totRow.getCell(4).numFmt="#,##0";

  // –ì—Ä–∞—Ñ–∏–∫ ‚Äî –î–æ—Ö–æ–¥—ã vs –†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º
  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ (—Å—Ç–æ–ª–±–µ—Ü —Å –±–ª–æ–∫–∞–º–∏ ‚ñà)
  if(months.length > 0) {
    ws1.getColumn(6).width = 30;
    ws1.getCell("F2").value = "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è";
    ws1.getCell("F2").font = {bold:true,color:{argb:"FFFFFF"},size:11};
    ws1.getCell("F2").fill = {type:"pattern",pattern:"solid",fgColor:{argb:purple}};
    ws1.getCell("F2").alignment = {horizontal:"center",vertical:"middle"};
    var maxVal = Math.max.apply(null,months.map(function(m){return Math.max(byM[m].inc,byM[m].exp)}).concat([1]));
    months.forEach(function(m,i){
      var d=byM[m];
      var gLen = Math.max(1,Math.round((d.inc/maxVal)*20));
      var rLen = Math.max(1,Math.round((d.exp/maxVal)*20));
      var bar = "‚ñì".repeat(gLen) + " ‚Üë  " + "‚ñì".repeat(rLen) + " ‚Üì";
      var cell = ws1.getCell("F"+(dataStartRow+i));
      cell.value = bar;
      cell.font = {size:9,color:{argb:subC}};
    });
  }

  // ‚îÄ‚îÄ‚îÄ –õ–∏—Å—Ç 2: –ë–∞–ª–∞–Ω—Å—ã –ø–æ —Å—á–µ—Ç–∞–º ‚îÄ‚îÄ‚îÄ
  var ws2 = wb.addWorksheet("–ë–∞–ª–∞–Ω—Å—ã", {properties:{tabColor:{argb:greenC}}});
  ws2.properties.defaultRowHeight = 22;
  ws2.columns = [{width:18},{width:16},{width:16},{width:16}];

  ws2.mergeCells("A1:D1");
  var t2 = ws2.getCell("A1");
  t2.value = "üè¶ –ë–ê–õ–ê–ù–°–´ –ü–û –°–ß–ï–¢–ê–ú";
  t2.font = {bold:true,size:14,color:{argb:purple}};
  t2.alignment = {horizontal:"center"};
  ws2.getRow(1).height = 36;

  var h2 = ws2.addRow(["–°—á—ë—Ç","–û—Å—Ç–∞—Ç–æ–∫","–î–æ—Ö–æ–¥—ã","–†–∞—Å—Ö–æ–¥—ã"]);
  styleHeader(h2);

  ACCOUNTS.forEach(function(a){
    var inc=entries.filter(function(e){return e.account===a&&e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
    var exp=entries.filter(function(e){return e.account===a&&e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
    var bal=overrides[a]!==undefined?overrides[a]:(inc-exp);
    var row=ws2.addRow([ICONS[a]+" "+a, bal, inc, exp]);
    styleCell(row.getCell(1),false);
    styleCell(row.getCell(2),true,bal>=0?greenC:redC);
    styleCell(row.getCell(3),true,greenC);
    styleCell(row.getCell(4),true,redC);
    row.getCell(2).numFmt="#,##0";
    row.getCell(3).numFmt="#,##0";
    row.getCell(4).numFmt="#,##0";
  });

  // –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ –¥–ª—è –±–∞–ª–∞–Ω—Å–æ–≤
  ws2.getColumn(5).width = 25;
  ws2.getCell("E2").value = "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è";
  ws2.getCell("E2").font = {bold:true,color:{argb:"FFFFFF"},size:11};
  ws2.getCell("E2").fill = {type:"pattern",pattern:"solid",fgColor:{argb:purple}};
  ws2.getCell("E2").alignment = {horizontal:"center",vertical:"middle"};
  var maxBal = Math.max.apply(null,ACCOUNTS.map(function(a){
    var inc=entries.filter(function(e){return e.account===a&&e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
    var exp=entries.filter(function(e){return e.account===a&&e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
    return Math.abs(overrides[a]!==undefined?overrides[a]:(inc-exp));
  }).concat([1]));
  ACCOUNTS.forEach(function(a,i){
    var inc=entries.filter(function(e){return e.account===a&&e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
    var exp=entries.filter(function(e){return e.account===a&&e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
    var bal=overrides[a]!==undefined?overrides[a]:(inc-exp);
    var bLen = Math.max(1,Math.round((Math.abs(bal)/maxBal)*18));
    var cell = ws2.getCell("E"+(3+i));
    cell.value = (bal>=0?"‚ñà":"‚ñë").repeat(bLen);
    cell.font = {size:10,color:{argb:bal>=0?greenC:redC}};
  });

  // ‚îÄ‚îÄ‚îÄ –õ–∏—Å—Ç 3: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ
  var ws3 = wb.addWorksheet("–û–ø–µ—Ä–∞—Ü–∏–∏", {properties:{tabColor:{argb:amberC}}});
  ws3.properties.defaultRowHeight = 22;
  ws3.columns = [{width:14},{width:10},{width:14},{width:12},{width:18},{width:14},{width:28}];

  ws3.mergeCells("A1:G1");
  var t3 = ws3.getCell("A1");
  t3.value = "üìã –í–°–ï –û–ü–ï–†–ê–¶–ò–ò";
  t3.font = {bold:true,size:14,color:{argb:purple}};
  t3.alignment = {horizontal:"center"};
  ws3.getRow(1).height = 36;

  var h3 = ws3.addRow(["–î–∞—Ç–∞","–¢–∏–ø","–°—á—ë—Ç","–ù–∞–ª/–ë–µ–∑–Ω–∞–ª","–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–°—É–º–º–∞","–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]);
  styleHeader(h3);

  // –ê–≤—Ç–æ—Ñ–∏–ª—å—Ç—Ä
  ws3.autoFilter = "A2:G2";

  entries.slice().sort(function(a,b){return new Date(b.date)-new Date(a.date)}).forEach(function(e){
    var isInc = e.type==="income";
    var row = ws3.addRow([
      new Date(e.date).toLocaleDateString("ru-RU"),
      isInc?"‚ñ≤ –î–æ—Ö–æ–¥":"‚ñº –†–∞—Å—Ö–æ–¥",
      e.account,
      e.payType==="cash"?"üíµ –ù–∞–ª":"üí≥ –ë–µ–∑–Ω–∞–ª",
      e.category,
      e.amount,
      e.comment||""
    ]);
    styleCell(row.getCell(1),false);
    row.getCell(2).font = {color:{argb:isInc?greenC:redC},bold:true,size:10};
    styleCell(row.getCell(3),false);
    styleCell(row.getCell(4),false);
    styleCell(row.getCell(5),false);
    styleCell(row.getCell(6),true,isInc?greenC:redC);
    row.getCell(6).numFmt="#,##0";
    styleCell(row.getCell(7),false,subC);
  });

  // ‚îÄ‚îÄ‚îÄ –õ–∏—Å—Ç 4: –°–≤–æ–¥–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ‚îÄ‚îÄ‚îÄ
  var ws4 = wb.addWorksheet("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏", {properties:{tabColor:{argb:amberC}}});
  ws4.properties.defaultRowHeight = 22;
  ws4.columns = [{width:22},{width:16},{width:12}];

  ws4.mergeCells("A1:C1");
  var t4 = ws4.getCell("A1");
  t4.value = "üìÇ –†–ê–°–•–û–î–´ –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú";
  t4.font = {bold:true,size:14,color:{argb:purple}};
  t4.alignment = {horizontal:"center"};
  ws4.getRow(1).height = 36;

  var h4 = ws4.addRow(["–ö–∞—Ç–µ–≥–æ—Ä–∏—è","–°—É–º–º–∞","–î–æ–ª—è"]);
  styleHeader(h4);

  var byCat={};
  entries.filter(function(e){return e.type==="expense"}).forEach(function(e){byCat[e.category]=(byCat[e.category]||0)+e.amount;});
  var catKeys=Object.keys(byCat).sort(function(a,b){return byCat[b]-byCat[a]});
  var catTotal=catKeys.reduce(function(s,k){return s+byCat[k]},0);

  catKeys.forEach(function(cat){
    var pct = catTotal>0 ? ((byCat[cat]/catTotal)*100).toFixed(1)+"%" : "0%";
    var row = ws4.addRow([cat, byCat[cat], pct]);
    styleCell(row.getCell(1),false);
    styleCell(row.getCell(2),true,redC);
    row.getCell(2).numFmt="#,##0";
    styleCell(row.getCell(3),true,amberC);
  });

  // –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  if(catKeys.length>0){
    ws4.getColumn(4).width = 25;
    ws4.getCell("D2").value = "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è";
    ws4.getCell("D2").font = {bold:true,color:{argb:"FFFFFF"},size:11};
    ws4.getCell("D2").fill = {type:"pattern",pattern:"solid",fgColor:{argb:purple}};
    ws4.getCell("D2").alignment = {horizontal:"center",vertical:"middle"};
    var maxCat = Math.max.apply(null,catKeys.map(function(k){return byCat[k]}).concat([1]));
    catKeys.forEach(function(cat,i){
      var bLen = Math.max(1,Math.round((byCat[cat]/maxCat)*18));
      var cell = ws4.getCell("D"+(3+i));
      cell.value = "‚ñà".repeat(bLen);
      cell.font = {size:10,color:{argb:redC}};
    });
  }

  // ‚îÄ‚îÄ‚îÄ –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª ‚îÄ‚îÄ‚îÄ
  wb.xlsx.writeBuffer().then(function(buffer){
    var blob = new Blob([buffer],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "AirTime_" + new Date().toLocaleDateString("ru-RU").replace(/\./g,"-") + ".xlsx";
    a.click();
    URL.revokeObjectURL(url);
  });
}

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
function Dashboard(p){
  var entries=p.entries,ov=p.overrides;
  var tI=entries.filter(function(e){return e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
  var tE=entries.filter(function(e){return e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
  var byM={};entries.forEach(function(e){var k=mKey(e.date);if(!byM[k])byM[k]={inc:0,exp:0};if(e.type==="income")byM[k].inc+=e.amount;else byM[k].exp+=e.amount;});
  var months=Object.keys(byM).sort().slice(-6);
  var maxV=Math.max.apply(null,months.map(function(m){return Math.max(byM[m].inc,byM[m].exp)}).concat([1]));

  return h("div",{className:"fade-in"},
    h(SyncBadge,{sync:p.sync,lastSync:p.lastSync}),
    h("div",{style:{textAlign:"center",padding:"6px 0 18px"}},
      h("div",{style:{fontSize:11,color:C.sub,letterSpacing:2,textTransform:"uppercase",marginBottom:4}},"–û–±—â–∏–π –±–∞–ª–∞–Ω—Å"),
      h("div",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:34,color:tI-tE>=0?C.green:C.red,fontWeight:700}},(tI-tE>=0?"+":"")+fmt(tI-tE)),
      h("div",{style:{display:"flex",justifyContent:"center",gap:18,marginTop:8,fontSize:13}},h("span",{style:{color:C.green}},"‚Üë "+fmt(tI)),h("span",{style:{color:C.red}},"‚Üì "+fmt(tE)))),
    h("div",{style:{display:"flex",gap:8,marginBottom:16}},
      ACCOUNTS.map(function(a){
        var inc=entries.filter(function(e){return e.account===a&&e.type==="income"}).reduce(function(s,e){return s+e.amount},0);
        var exp=entries.filter(function(e){return e.account===a&&e.type==="expense"}).reduce(function(s,e){return s+e.amount},0);
        var o=ov[a],d=o!==undefined?o:(inc-exp);
        return h(Card,{key:a,style:{flex:1,background:C.card2,padding:"12px 10px",textAlign:"center"}},
          h("div",{style:{fontSize:18,marginBottom:4}},ICONS[a]),h("div",{style:{fontSize:10,color:C.sub,marginBottom:4}},a),
          h("div",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:12,color:d>=0?C.al:C.red,fontWeight:700,lineHeight:1.3}},fmt(d)),
          o!==undefined?h("div",{style:{fontSize:9,color:C.amber,marginTop:3}},"‚ú± —Å–∫–æ—Ä—Ä."):null);})),
    months.length>0?h(Card,{style:{marginBottom:14}},
      h("div",{style:{fontSize:11,color:C.sub,letterSpacing:1,textTransform:"uppercase",marginBottom:14}},"–î–∏–Ω–∞–º–∏–∫–∞"),
      h("div",{style:{display:"flex",alignItems:"flex-end",gap:6,height:90}},months.map(function(m){var d=byM[m];return h("div",{key:m,style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center"}},h("div",{style:{display:"flex",gap:3,alignItems:"flex-end",height:82}},h("div",{style:{width:10,height:Math.max(Math.round((d.inc/maxV)*80),2),background:C.green,borderRadius:"3px 3px 0 0",opacity:.85}}),h("div",{style:{width:10,height:Math.max(Math.round((d.exp/maxV)*80),2),background:C.red,borderRadius:"3px 3px 0 0",opacity:.85}})),h("div",{style:{fontSize:9,color:C.sub,marginTop:4}},mLabel(m).slice(0,3)));})),
      h("div",{style:{display:"flex",gap:14,marginTop:8,fontSize:11,color:C.sub}},h("span",null,h("span",{style:{color:C.green}},"‚ñ†")," –î–æ—Ö–æ–¥"),h("span",null,h("span",{style:{color:C.red}},"‚ñ†")," –†–∞—Å—Ö–æ–¥"))):null,
    Object.keys(byM).length>0?h(Card,{style:{marginBottom:14}},
      h("div",{style:{fontSize:11,color:C.sub,letterSpacing:1,textTransform:"uppercase",marginBottom:12}},"–ü–æ –º–µ—Å—è—Ü–∞–º"),
      Object.keys(byM).sort(function(a,b){return b.localeCompare(a)}).map(function(m){var d=byM[m],pr=d.inc-d.exp;return h("div",{key:m,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 0",borderBottom:"1px solid "+C.border}},h("span",{style:{fontSize:13,color:C.text}},mLabel(m)),h("div",{style:{textAlign:"right"}},h("div",{style:{fontSize:12,color:pr>=0?C.green:C.red,fontWeight:700}},(pr>=0?"+":"")+fmt(pr)),h("div",{style:{fontSize:10,color:C.sub}},"‚Üë"+fmt(d.inc)+" ‚Üì"+fmt(d.exp))));})):null,
    h("button",{onClick:p.onExport,style:{width:"100%",padding:"14px",borderRadius:14,border:"1.5px solid "+C.border,background:"transparent",color:C.al,cursor:"pointer",fontSize:14,fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:8}},h("span",null,"üì•")," –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (.xlsx)"));
}

// ‚îÄ‚îÄ‚îÄ –ü–ê–†–û–õ–¨ –î–õ–Ø –í–•–û–î–ê ‚îÄ‚îÄ‚îÄ
// ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –ø–∞—Ä–æ–ª—å –Ω–∞ —Å–≤–æ–π:
var APP_PASSWORD = "airtime2026";

function LoginScreen(p) {
  var _pw = useState(""), pw = _pw[0], setPw = _pw[1];
  var _err = useState(false), err = _err[0], setErr = _err[1];
  var _shake = useState(false), shake = _shake[0], setShake = _shake[1];

  function handleSubmit() {
    if (pw === APP_PASSWORD) {
      try { sessionStorage.setItem("at_auth", "1"); } catch(e) {}
      p.onSuccess();
    } else {
      setErr(true);
      setShake(true);
      setTimeout(function(){ setShake(false); }, 500);
      setTimeout(function(){ setErr(false); }, 2000);
    }
  }

  function handleKey(e) {
    if (e.key === "Enter") handleSubmit();
  }

  return h("div", {style: {maxWidth:430,margin:"0 auto",minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:20}},
    h("div", {style: {textAlign:"center",marginBottom:40}},
      h("div", {style: {fontSize:48,marginBottom:12}}, "üé¨"),
      h("div", {style: {fontFamily:"'Unbounded',sans-serif",fontSize:24,color:C.text,fontWeight:700,letterSpacing:-0.5}}, "Air Time"),
      h("div", {style: {fontSize:11,color:C.muted,letterSpacing:2,textTransform:"uppercase",marginTop:4}}, "—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä")),
    h("div", {style: {width:"100%",maxWidth:300,animation:shake?"shake .4s ease":"none"}},
      h("div", {style: {fontSize:11,color:C.sub,letterSpacing:1.5,textTransform:"uppercase",marginBottom:10,textAlign:"center"}}, "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"),
      h("input", {
        type: "password",
        value: pw,
        onChange: function(e){ setPw(e.target.value); setErr(false); },
        onKeyDown: handleKey,
        autoFocus: true,
        placeholder: "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",
        style: {width:"100%",boxSizing:"border-box",padding:"16px",background:C.card2,border:"2px solid "+(err?C.red:C.border),borderRadius:14,color:C.white,fontSize:18,fontFamily:"'Unbounded',sans-serif",textAlign:"center",outline:"none",letterSpacing:4,transition:"border-color .3s"}
      }),
      err ? h("div", {style: {textAlign:"center",color:C.red,fontSize:12,marginTop:10,animation:"fadeIn .3s"}}, "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å") : null,
      h("button", {
        onClick: handleSubmit,
        style: {width:"100%",padding:"14px",marginTop:16,borderRadius:14,border:"none",background:pw?C.accent:C.muted,color:C.white,cursor:pw?"pointer":"default",opacity:pw?1:.5,fontSize:15,fontWeight:700,fontFamily:"'Unbounded',sans-serif",transition:"all .2s"}
      }, "üîì –í–æ–π—Ç–∏")),
    h("div", {style: {marginTop:30,fontSize:11,color:C.muted,textAlign:"center"}}, "–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã"));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function App(){
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –≤—Ö–æ–¥ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
  var wasAuth = false;
  try { wasAuth = sessionStorage.getItem("at_auth") === "1"; } catch(e) {}
  var _auth = useState(wasAuth), authed = _auth[0], setAuthed = _auth[1];

  if (!authed) {
    return h(LoginScreen, {onSuccess: function(){ setAuthed(true); }});
  }

  var _t=useState("add"),tab=_t[0],setTab=_t[1];
  var _e=useState([]),entries=_e[0],setEntries=_e[1];
  var _o=useState({}),overrides=_o[0],setOverrides=_o[1];
  var _l=useState(true),loading=_l[0],setLoading=_l[1];
  var _s=useState(firebaseReady?"cloud":"local"),sync=_s[0],setSync=_s[1];
  var _ls=useState(null),lastSync=_ls[0],setLastSync=_ls[1];
  var wE=useRef(false),wB=useRef(false);

  useEffect(function(){
    var u1=null,u2=null;
    if(firebaseReady){
      setSync("cloud");
      u1=subscribeDoc("entries",function(v){if(wE.current)return;try{setEntries(JSON.parse(v));setLastSync(new Date().toLocaleTimeString("ru-RU"));}catch(e){}});
      u2=subscribeDoc("balances",function(v){if(wB.current)return;try{setOverrides(JSON.parse(v));setLastSync(new Date().toLocaleTimeString("ru-RU"));}catch(e){}});
      Promise.all([loadDoc("entries"),loadDoc("balances")]).then(function(r){
        try{if(r[0])setEntries(JSON.parse(r[0]));}catch(e){}
        try{if(r[1])setOverrides(JSON.parse(r[1]));}catch(e){}
        setLoading(false);
      });
    }else{
      setSync("local");
      try{var r=localStorage.getItem("at_entries");if(r)setEntries(JSON.parse(r));}catch(e){}
      try{var r2=localStorage.getItem("at_balances");if(r2)setOverrides(JSON.parse(r2));}catch(e){}
      setLoading(false);
    }
    return function(){if(u1)u1();if(u2)u2();};
  },[]);

  function doSaveE(next){
    setEntries(next);wE.current=true;
    return saveDoc("entries",JSON.stringify(next)).then(function(){setLastSync(new Date().toLocaleTimeString("ru-RU"));setTimeout(function(){wE.current=false;},1500);});
  }
  function doSaveO(next){
    setOverrides(next);wB.current=true;
    return saveDoc("balances",JSON.stringify(next)).then(function(){setLastSync(new Date().toLocaleTimeString("ru-RU"));setTimeout(function(){wB.current=false;},1500);});
  }

  var tabs=[{id:"add",icon:"Ôºã",label:"–í–Ω–µ—Å—Ç–∏"},{id:"history",icon:"‚ò∞",label:"–ò—Å—Ç–æ—Ä–∏—è"},{id:"balances",icon:"‚öñ",label:"–ë–∞–ª–∞–Ω—Å"},{id:"dashboard",icon:"‚óà",label:"–ò—Ç–æ–≥–∏"}];

  var content;
  if(loading)content=h("div",{style:{textAlign:"center",padding:"80px 0",color:C.sub}},h("div",{style:{fontSize:32,marginBottom:12},className:"sync-pulse"},"‚òÅÔ∏è"),h("div",null,"–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞–∫—É..."));
  else if(tab==="add")content=h(EntryForm,{onSave:function(e){sendTelegramNotify(e,entries,overrides);return doSaveE(entries.concat([e]));}});
  else if(tab==="history")content=h(History,{entries:entries,onDelete:function(id){return doSaveE(entries.filter(function(e){return e.id!==id}));}});
  else if(tab==="balances")content=h(BalanceCorrection,{overrides:overrides,onSave:doSaveO});
  else if(tab==="dashboard")content=h(Dashboard,{entries:entries,overrides:overrides,onExport:function(){doExport(entries,overrides)},sync:sync,lastSync:lastSync});

  return h("div",{style:{maxWidth:430,margin:"0 auto",minHeight:"100vh",background:C.bg,display:"flex",flexDirection:"column"}},
    h("div",{style:{padding:"18px 18px 12px",background:"linear-gradient(180deg,#16163a 0%,#0f0f1e 100%)",borderBottom:"1px solid "+C.border}},
      h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"}},
        h("div",null,h("div",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:17,color:C.text,fontWeight:700,letterSpacing:-.5}},"Air Time"),h("div",{style:{fontSize:10,color:C.muted,letterSpacing:1.5,textTransform:"uppercase"}},"—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç—Ä–µ–∫–µ—Ä")),
        h("div",{style:{display:"flex",alignItems:"center",gap:8}},
          h("div",{style:{width:8,height:8,borderRadius:4,background:sync==="cloud"?C.green:C.amber,boxShadow:"0 0 6px "+(sync==="cloud"?C.green:C.amber)}}),
          h("div",{style:{width:38,height:38,borderRadius:11,background:"#7c3aed25",border:"1px solid #7c3aed44",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}},"üé¨")))),
    h("div",{style:{flex:1,padding:"18px 16px 84px",overflowY:"auto"}},content),
    h("div",{style:{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:"100%",maxWidth:430,background:"#14143a",borderTop:"1px solid "+C.border,display:"flex",padding:"8px 0 14px"}},
      tabs.map(function(t){return h("button",{key:t.id,onClick:function(){setTab(t.id)},style:{flex:1,background:"none",border:"none",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:3,padding:"5px 0"}},h("span",{style:{fontSize:19,filter:tab===t.id?"none":"grayscale(1)",opacity:tab===t.id?1:.35,transition:"all .2s"}},t.icon),h("span",{style:{fontSize:10,color:tab===t.id?C.al:C.muted,fontWeight:tab===t.id?600:400}},t.label));})));
}

ReactDOM.createRoot(document.getElementById("root")).render(h(App));
  </script>
</body>
</html>
