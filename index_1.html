<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#0f0f1e"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Air Time"/>
  <title>Air Time â€” Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700&family=DM+Sans:wght@400;600&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{background:#0f0f1e;min-height:100vh;font-family:'DM Sans',sans-serif;color:#e2e2f0;}
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
    input,button{font-family:'DM Sans',sans-serif;}
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-track{background:#0f0f1e;}
    ::-webkit-scrollbar-thumb{background:#3a3a5a;border-radius:2px;}
    .app{max-width:430px;margin:0 auto;min-height:100vh;background:#0f0f1e;display:flex;flex-direction:column;}
    .header{padding:18px 18px 12px;background:linear-gradient(180deg,#16163a 0%,#0f0f1e 100%);border-bottom:1px solid #2e2e4a;}
    .header-inner{display:flex;align-items:center;justify-content:space-between;}
    .header-logo{font-family:'Unbounded',sans-serif;font-size:17px;color:#e2e2f0;font-weight:700;letter-spacing:-0.5px;}
    .header-sub{font-size:10px;color:#3a3a5a;letter-spacing:1.5px;text-transform:uppercase;}
    .header-icon{width:38px;height:38px;border-radius:11px;background:#7c3aed25;border:1px solid #7c3aed44;display:flex;align-items:center;justify-content:center;font-size:18px;}
    .content{flex:1;padding:18px 16px 84px;overflow-y:auto;}
    .nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:#14143a;border-top:1px solid #2e2e4a;display:flex;padding:8px 0 14px;}
    .nav-btn{flex:1;background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;padding:5px 0;}
    .nav-icon{font-size:19px;transition:all .2s;}
    .nav-label{font-size:10px;font-weight:400;}
    .card{background:#1a1a30;border-radius:18px;padding:16px;}
    .card2{background:#222238;border-radius:18px;padding:16px;}
    .lbl{font-size:11px;color:#7878a0;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px;}
    .choice-row{display:flex;gap:12px;}
    .choice-btn{flex:1;padding:16px 10px;border-radius:14px;cursor:pointer;font-size:13px;font-family:'Unbounded',sans-serif;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all .2s;border:2px solid #2e2e4a;background:#222238;color:#7878a0;}
    .choice-btn.active{transform:scale(1.04);}
    .pill-wrap{display:flex;flex-wrap:wrap;gap:8px;}
    .pill{padding:9px 16px;border-radius:50px;border:1.5px solid #2e2e4a;background:transparent;color:#7878a0;cursor:pointer;font-size:13px;font-weight:400;transition:all .15s;white-space:nowrap;}
    .pill.active{color:#fff;}
    .big-input-wrap{position:relative;}
    .big-input{width:100%;box-sizing:border-box;padding:16px 52px 16px 16px;background:#222238;border:2px solid #2e2e4a;border-radius:14px;color:#fff;font-size:30px;font-family:'Unbounded',sans-serif;outline:none;}
    .big-input-suffix{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:#7878a0;font-size:16px;}
    .txt-input{width:100%;box-sizing:border-box;padding:12px 14px;background:#222238;border:2px solid #2e2e4a;border-radius:12px;color:#fff;font-size:14px;outline:none;}
    .dots{display:flex;gap:6px;justify-content:center;margin:8px 0 18px;}
    .dot{height:7px;border-radius:4px;transition:all .3s;}
    .btn-row{display:flex;gap:10px;margin-top:22px;}
    .btn{padding:13px;border-radius:12px;border:none;color:#fff;cursor:pointer;font-size:15px;font-family:'DM Sans',sans-serif;font-weight:700;transition:all .2s;flex:1;}
    .btn-back{padding:13px 18px;border-radius:12px;border:none;background:#222238;color:#7878a0;cursor:pointer;font-size:14px;font-weight:600;}
    .saved-screen{text-align:center;padding:72px 0;}
    .history-month-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .entry-row{display:flex;align-items:center;gap:10px;padding:11px 13px;margin-bottom:5px;background:#1a1a30;border-radius:12px;}
    .entry-info{flex:1;min-width:0;}
    .entry-cat{font-size:13px;color:#e2e2f0;font-weight:600;}
    .entry-comment{font-size:11px;color:#3a3a5a;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .entry-amount{font-family:'Unbounded',sans-serif;font-size:12px;font-weight:700;}
    .entry-date{font-size:10px;color:#3a3a5a;margin-top:2px;}
    .del-btn{background:none;border:none;color:#3a3a5a;cursor:pointer;font-size:15px;}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #2e2e4a;}
    .empty{text-align:center;padding:60px 0;}
    .sync-status{text-align:center;margin-bottom:10px;font-size:11px;}
    .balance-total{text-align:center;padding:6px 0 18px;}
    .account-cards{display:flex;gap:8px;margin-bottom:16px;}
    .account-card{flex:1;background:#222238;border-radius:18px;padding:12px 10px;text-align:center;}
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-inner">
      <div>
        <div class="header-logo">Air Time</div>
        <div class="header-sub">Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞºĞµÑ€</div>
      </div>
      <div class="header-icon">ğŸ¬</div>
    </div>
  </div>
  <div class="content" id="content">
    <div style="text-align:center;padding:80px 0;color:#7878a0">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div>
  </div>
  <div class="nav" id="nav"></div>
</div>

<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ½Ğ° ÑĞ²Ğ¾Ğ¸ Ğ¸Ğ· Firebase Console:
// console.firebase.google.com â†’ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ âš™ï¸ â†’ Your apps â†’ Config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyC51J93AA-IDYvab2jzuJjFPxFTO6OD3IE",
  authDomain: "airtime-finance.firebaseapp.com",
  projectId: "airtime-finance",
  storageBucket: "airtime-finance.firebasestorage.app",
  messagingSenderId: "897898898287",
  appId: "1:897898898287:web:b42c91c339a4ec2fe7be9a",
};
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ACCOUNTS = ["ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½","ĞšĞ¸Ğ±ĞµÑ€ÑĞ¿Ğ¾Ñ€Ñ‚","ĞĞ°Ğ»"];
const INCOME_CATS = ["Ğ¡ÑŠÑ‘Ğ¼ĞºĞ°","ĞœĞ¾Ğ½Ñ‚Ğ°Ğ¶/Ğ¿Ğ¾ÑÑ‚Ğ¿Ñ€Ğ¾Ğ´","Ğ¢Ñ€Ğ°Ğ½ÑĞ»ÑÑ†Ğ¸Ñ","Ğ’ĞµĞ±Ğ¸Ğ½Ğ°Ñ€","Ğ’Ñ‹ĞµĞ·Ğ´Ğ½Ğ°Ñ ÑÑŠÑ‘Ğ¼ĞºĞ°","AI-Ğ²Ğ¸Ğ´ĞµĞ¾","ĞŸÑ€Ğ¾Ñ‡Ğ¸Ğ¹ Ğ´Ğ¾Ñ…Ğ¾Ğ´"];
const EXPENSE_CATS = ["ĞšĞ¾Ğ¼Ğ¼ÑƒĞ½Ğ°Ğ»ĞºĞ°","Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ğ°","ĞÑ€ĞµĞ½Ğ´Ğ°/Ñ…Ğ¾Ğ·","Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ°","ĞĞ±Ğ¾Ñ€ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ","ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸/ĞŸĞ","ĞĞ°Ğ»Ğ¾Ğ³Ğ¸/Ğ±ÑƒÑ…Ğ³Ğ°Ğ»Ñ‚ĞµÑ€","ĞŸÑ€Ğ¾Ñ‡ĞµĞµ"];
const MONTHS = ["Ğ¯Ğ½Ğ²","Ğ¤ĞµĞ²","ĞœĞ°Ñ€","ĞĞ¿Ñ€","ĞœĞ°Ğ¹","Ğ˜ÑĞ½","Ğ˜ÑĞ»","ĞĞ²Ğ³","Ğ¡ĞµĞ½","ĞĞºÑ‚","ĞĞ¾Ñ","Ğ”ĞµĞº"];
const ICONS = {"ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½":"ğŸ¬","ĞšĞ¸Ğ±ĞµÑ€ÑĞ¿Ğ¾Ñ€Ñ‚":"ğŸ®","ĞĞ°Ğ»":"ğŸ’µ"};
const C = {accent:"#7c3aed",al:"#a78bfa",green:"#22c55e",red:"#ef4444",amber:"#f59e0b",blue:"#3b82f6",sub:"#7878a0",muted:"#3a3a5a",white:"#fff"};

const fmt = n => new Intl.NumberFormat("ru-RU").format(Math.round(n||0))+" Ñ€.";
const mKey = d => { const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}`; };
const mLabel = k => { const [y,m]=k.split("-"); return `${MONTHS[parseInt(m)-1]} ${y}`; };
const el = (tag,attrs={},children=[]) => {
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){
    if(k==="style"&&typeof v==="object") Object.assign(e.style,v);
    else if(k.startsWith("on")) e.addEventListener(k.slice(2).toLowerCase(),v);
    else e[k]=v;
  }
  for(const c of children){
    if(c==null||c===false) continue;
    e.appendChild(typeof c==="string"?document.createTextNode(c):c);
  }
  return e;
};

// â”€â”€ Firebase / Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let firestoreDb=null, fsDoc, fsGetDoc, fsSetDoc;

async function initFirebase(){
  if(!FIREBASE_CONFIG.apiKey||FIREBASE_CONFIG.apiKey==="AIzaSyC51J93AA-IDYvab2jzuJjFPxFTO6OD3IE") return false;
  try{
    const {initializeApp} = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js");
    const fs = await import("https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js");
    const app = initializeApp(FIREBASE_CONFIG);
    firestoreDb = fs.getFirestore(app);
    fsDoc=fs.doc; fsGetDoc=fs.getDoc; fsSetDoc=fs.setDoc;
    return true;
  }catch(e){ console.error("Firebase:",e); return false; }
}

async function dbGet(key){
  if(firestoreDb){
    try{ const s=await fsGetDoc(fsDoc(firestoreDb,"airtime",key)); return s.exists()?s.data().value:null; }catch{ return null; }
  }
  return localStorage.getItem("at_"+key);
}
async function dbSet(key,value){
  if(firestoreDb){
    try{ await fsSetDoc(fsDoc(firestoreDb,"airtime",key),{value}); }catch(e){ console.error(e); }
  } else {
    localStorage.setItem("at_"+key,value);
  }
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let state = { tab:"add", entries:[], overrides:{}, sync:"local",
  form:{ step:0,type:null,acc:null,pay:null,cat:null,amt:"",cmt:"",done:false } };

async function init(){
  const ok = await initFirebase();
  state.sync = ok?"cloud":"local";
  try{ const r=await dbGet("entries"); if(r) state.entries=JSON.parse(r); }catch(_){}
  try{ const r=await dbGet("balances"); if(r) state.overrides=JSON.parse(r); }catch(_){}
  render();
}

async function saveEntries(next){ state.entries=next; await dbSet("entries",JSON.stringify(next)); render(); }
async function saveOverrides(next){ state.overrides=next; await dbSet("balances",JSON.stringify(next)); render(); }

function setState(patch){ Object.assign(state,patch); render(); }
function setForm(patch){ Object.assign(state.form,patch); render(); }

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function choiceBtn(label,icon,active,color,onClick){
  const b = el("button",{className:"choice-btn"+(active?" active":""),onclick:onClick},[
    el("span",{style:{fontSize:"26px"}},[ icon ]), label
  ]);
  b.style.borderColor = active?color:"#2e2e4a";
  b.style.background = active?color+"20":"#222238";
  b.style.color = active?color:"#7878a0";
  return b;
}
function pill(label,active,color,onClick){
  const b = el("button",{className:"pill"+(active?" active":""),onclick:onClick},[label]);
  b.style.borderColor = active?color:"#2e2e4a";
  b.style.background = active?color:"transparent";
  b.style.color = active?C.white:"#7878a0";
  return b;
}
function dots(total,cur){
  const w = el("div",{className:"dots"});
  for(let i=0;i<total;i++){
    const d = el("div",{className:"dot"});
    d.style.width = i===cur?"22px":"7px";
    d.style.background = i<cur?C.al:i===cur?C.accent:C.muted;
    w.appendChild(d);
  }
  return w;
}
function bigInput(value,onInput,autoFocus){
  const w = el("div",{className:"big-input-wrap"});
  const inp = el("input",{type:"number",className:"big-input",placeholder:"0",value,oninput:onInput});
  if(autoFocus) setTimeout(()=>inp.focus(),50);
  w.appendChild(inp);
  w.appendChild(el("span",{className:"big-input-suffix"},["Ñ€."]));
  return w;
}

// â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdd(){
  const f = state.form;
  if(f.done){
    return el("div",{className:"saved-screen"},[
      el("div",{style:{fontSize:"62px",marginBottom:"14px"}},["âœ…"]),
      el("div",{style:{color:C.al,fontFamily:"'Unbounded',sans-serif",fontSize:"17px"}},["Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!"])
    ]);
  }

  const isNal = f.acc==="ĞĞ°Ğ»";
  const STEPS = isNal?4:5;
  const cats = f.type==="income"?INCOME_CATS:EXPENSE_CATS;
  const effectivePay = isNal?"cash":f.pay;
  const ok = isNal
    ? [!!f.type,!!f.acc,!!f.cat,!!f.amt&&!isNaN(+f.amt)&&+f.amt>0]
    : [!!f.type,!!f.acc,!!f.pay,!!f.cat,!!f.amt&&!isNaN(+f.amt)&&+f.amt>0];

  const showPay = !isNal && f.step===2;
  const showCat = isNal?f.step===2:f.step===3;
  const showAmt = isNal?f.step===3:f.step===4;

  function next(){ if(ok[f.step]) setForm({step:f.step+1}); }
  function back(){ setForm({step:f.step-1}); }
  function submit(){
    if(!ok[STEPS-1]) return;
    const entry={id:Date.now(),date:new Date().toISOString(),type:f.type,account:f.acc,payType:effectivePay,category:f.cat,amount:+f.amt,comment:f.cmt};
    saveEntries([...state.entries,entry]);
    setForm({done:true});
    setTimeout(()=>setForm({step:0,type:null,acc:null,pay:null,cat:null,amt:"",cmt:"",done:false}),1500);
  }

  const wrap = el("div",{},[dots(STEPS,f.step)]);

  if(f.step===0){
    wrap.appendChild(el("div",{className:"lbl"},["Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸"]));
    wrap.appendChild(el("div",{className:"choice-row"},[
      choiceBtn("Ğ”Ğ¾Ñ…Ğ¾Ğ´","ğŸ“ˆ",f.type==="income",C.green,()=>setForm({type:"income"})),
      choiceBtn("Ğ Ğ°ÑÑ…Ğ¾Ğ´","ğŸ“‰",f.type==="expense",C.red,()=>setForm({type:"expense"}))
    ]));
  }
  if(f.step===1){
    wrap.appendChild(el("div",{className:"lbl"},["Ğ¡Ñ‡Ñ‘Ñ‚"]));
    wrap.appendChild(el("div",{className:"choice-row"},
      ACCOUNTS.map(a=>choiceBtn(a,ICONS[a],f.acc===a,C.accent,()=>setForm({acc:a,pay:null})))
    ));
  }
  if(showPay){
    wrap.appendChild(el("div",{className:"lbl"},["Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹"]));
    wrap.appendChild(el("div",{className:"choice-row"},[
      choiceBtn("ĞĞ°Ğ»","ğŸ’µ",f.pay==="cash",C.amber,()=>setForm({pay:"cash"})),
      choiceBtn("Ğ‘ĞµĞ·Ğ½Ğ°Ğ»","ğŸ’³",f.pay==="card",C.blue,()=>setForm({pay:"card"}))
    ]));
  }
  if(showCat){
    wrap.appendChild(el("div",{className:"lbl"},["ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ"]));
    wrap.appendChild(el("div",{className:"pill-wrap"},cats.map(c=>pill(c,f.cat===c,C.accent,()=>setForm({cat:c})))));
  }
  if(showAmt){
    wrap.appendChild(el("div",{className:"lbl"},["Ğ¡ÑƒĞ¼Ğ¼Ğ°"]));
    wrap.appendChild(bigInput(f.amt,e=>setForm({amt:e.target.value}),true));
    wrap.appendChild(el("div",{style:{marginTop:"14px",marginBottom:"6px"}},[el("div",{className:"lbl"},["ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)"])]));
    const ti = el("input",{type:"text",className:"txt-input",placeholder:"ĞšĞ»Ğ¸ĞµĞ½Ñ‚, Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ...",value:f.cmt,oninput:e=>setForm({cmt:e.target.value})});
    wrap.appendChild(ti);
    const preview = el("div",{className:"card2",style:{marginTop:"16px",fontSize:"13px",color:"#7878a0",lineHeight:"2"}});
    const sp = el("span",{style:{fontWeight:"700",color:f.type==="income"?C.green:C.red}},[f.type==="income"?"â–² Ğ”Ğ¾Ñ…Ğ¾Ğ´":"â–¼ Ğ Ğ°ÑÑ…Ğ¾Ğ´"]);
    preview.appendChild(sp);
    preview.appendChild(document.createTextNode("  Â·  "+f.acc+((!isNal)?"  Â·  "+(effectivePay==="cash"?"ğŸ’µ ĞĞ°Ğ»":"ğŸ’³ Ğ‘ĞµĞ·Ğ½Ğ°Ğ»"):""+(f.cat?"  Â·  "+f.cat:""))));
    wrap.appendChild(preview);
  }

  const btnRow = el("div",{className:"btn-row"});
  if(f.step>0) btnRow.appendChild(el("button",{className:"btn-back",onclick:back},["â† ĞĞ°Ğ·Ğ°Ğ´"]));
  if(f.step<STEPS-1){
    const nb = el("button",{className:"btn",onclick:next},["Ğ”Ğ°Ğ»ĞµĞµ â†’"]);
    nb.style.background = ok[f.step]?C.accent:C.muted;
    nb.style.opacity = ok[f.step]?"1":"0.45";
    nb.style.cursor = ok[f.step]?"pointer":"default";
    btnRow.appendChild(nb);
  } else {
    const sb = el("button",{className:"btn",onclick:submit},["ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ"]);
    sb.style.background = ok[STEPS-1]?C.green:C.muted;
    sb.style.opacity = ok[STEPS-1]?"1":"0.45";
    sb.style.cursor = ok[STEPS-1]?"pointer":"default";
    btnRow.appendChild(sb);
  }
  wrap.appendChild(btnRow);
  return wrap;
}

function renderHistory(){
  const entries = state.entries;
  if(!entries.length){
    return el("div",{className:"empty"},[
      el("div",{style:{fontSize:"48px",marginBottom:"10px"}},["ğŸ“­"]),
      el("div",{style:{color:C.sub}},["ĞĞµÑ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹"])
    ]);
  }
  const sorted = [...entries].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const byM={};
  for(const e of sorted){const k=mKey(e.date);if(!byM[k])byM[k]=[];byM[k].push(e);}
  const wrap = el("div",{});
  for(const month of Object.keys(byM).sort((a,b)=>b.localeCompare(a))){
    const items=byM[month];
    const inc=items.filter(e=>e.type==="income").reduce((s,e)=>s+e.amount,0);
    const exp=items.filter(e=>e.type==="expense").reduce((s,e)=>s+e.amount,0);
    const mw = el("div",{style:{marginBottom:"22px"}});
    const mh = el("div",{className:"history-month-header"});
    mh.appendChild(el("span",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:"12px",color:C.al}},[mLabel(month)]));
    const ms = el("span",{style:{fontSize:"12px"}});
    ms.appendChild(el("span",{style:{color:C.green}},["+"+(fmt(inc))]));
    ms.appendChild(el("span",{style:{color:C.muted,margin:"0 5px"}},["Â·"]));
    ms.appendChild(el("span",{style:{color:C.red}},["âˆ’"+(fmt(exp))]));
    mh.appendChild(ms); mw.appendChild(mh);
    for(const e of items){
      const row = el("div",{className:"entry-row"});
      row.style.borderLeft = `3px solid ${e.type==="income"?C.green:C.red}`;
      row.appendChild(el("span",{style:{fontSize:"18px"}},[e.payType==="cash"?"ğŸ’µ":"ğŸ’³"]));
      const info = el("div",{className:"entry-info"});
      const cat = el("div",{className:"entry-cat"},[e.category+" "]);
      cat.appendChild(el("span",{style:{color:C.muted,fontWeight:"400"}},["Â· "+e.account]));
      info.appendChild(cat);
      if(e.comment) info.appendChild(el("div",{className:"entry-comment"},[e.comment]));
      row.appendChild(info);
      const right = el("div",{style:{textAlign:"right"}});
      const amt = el("div",{className:"entry-amount",style:{color:e.type==="income"?C.green:C.red}},[(e.type==="income"?"+":"âˆ’")+fmt(e.amount)]);
      const dt = el("div",{className:"entry-date"},[new Date(e.date).toLocaleDateString("ru-RU")]);
      right.appendChild(amt); right.appendChild(dt); row.appendChild(right);
      const del = el("button",{className:"del-btn",onclick:()=>saveEntries(state.entries.filter(x=>x.id!==e.id))},["âœ•"]);
      row.appendChild(del);
      mw.appendChild(row);
    }
    wrap.appendChild(mw);
  }
  return wrap;
}

function renderBalances(){
  const ov = state.overrides;
  const vals = {};
  ACCOUNTS.forEach(a=>{ vals[a]=ov[a]!==undefined?String(ov[a]):""; });

  const wrap = el("div",{});
  wrap.appendChild(el("div",{className:"card2",style:{marginBottom:"16px",fontSize:"13px",color:C.sub,lineHeight:"1.7"}},
    ["Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ ÑÑ‡Ñ‘Ñ‚Ğµ. Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ğ½ĞµÑ‚ÑÑ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹."]));

  const inputs={};
  for(const a of ACCOUNTS){
    wrap.appendChild(el("div",{className:"lbl"},[ICONS[a]+"  "+a]));
    const w = el("div",{className:"big-input-wrap",style:{marginBottom:"18px"}});
    const inp = el("input",{type:"number",className:"big-input",placeholder:"Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº",value:vals[a],
      oninput:e=>{ vals[a]=e.target.value; }});
    w.appendChild(inp);
    w.appendChild(el("span",{className:"big-input-suffix"},["Ñ€."]));
    inputs[a]=inp; wrap.appendChild(w);
  }

  const saveBtn = el("button",{className:"btn",style:{background:C.accent,width:"100%",padding:"14px",borderRadius:"14px"},
    onclick:async ()=>{
      const r={};
      ACCOUNTS.forEach(a=>{ const v=inputs[a].value; if(v!==""&&!isNaN(+v)) r[a]=+v; });
      await saveOverrides(r);
      saveBtn.textContent="âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!";
      saveBtn.style.background=C.green;
      setTimeout(()=>{ saveBtn.textContent="ğŸ’¾ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ"; saveBtn.style.background=C.accent; },2000);
    }},["ğŸ’¾ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ"]);
  wrap.appendChild(saveBtn);

  if(Object.keys(ov).length>0){
    wrap.appendChild(el("div",{style:{marginTop:"22px"}},[el("div",{className:"lbl"},["ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸"])]));
    for(const a of ACCOUNTS.filter(a=>ov[a]!==undefined)){
      const row = el("div",{className:"summary-row"});
      row.appendChild(el("span",{style:{color:C.sub}},[ICONS[a]+"  "+a]));
      row.appendChild(el("span",{style:{color:C.al,fontWeight:"600"}},[fmt(ov[a])]));
      wrap.appendChild(row);
    }
    const resetBtn = el("button",{style:{marginTop:"14px",padding:"10px 16px",borderRadius:"10px",border:"1px solid #2e2e4a",background:"transparent",color:C.red,cursor:"pointer",fontSize:"12px"},
      onclick:()=>saveOverrides({})},["Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸"]);
    wrap.appendChild(resetBtn);
  }
  return wrap;
}

function renderDashboard(){
  const {entries,overrides,sync} = state;
  const tI=entries.filter(e=>e.type==="income").reduce((s,e)=>s+e.amount,0);
  const tE=entries.filter(e=>e.type==="expense").reduce((s,e)=>s+e.amount,0);
  const byM={};
  for(const e of entries){const k=mKey(e.date);if(!byM[k])byM[k]={inc:0,exp:0};if(e.type==="income")byM[k].inc+=e.amount;else byM[k].exp+=e.amount;}
  const months=Object.keys(byM).sort().slice(-6);
  const maxV=Math.max(...months.map(m=>Math.max(byM[m].inc,byM[m].exp)),1);

  const wrap = el("div",{});

  // Sync status
  const ss = el("div",{className:"sync-status"});
  ss.appendChild(el("span",{style:{color:sync==="cloud"?C.green:C.amber}},
    [sync==="cloud"?"â˜ï¸ ĞĞ±Ğ»Ğ°ĞºĞ¾ (Firebase) â€” ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°":"ğŸ’¾ Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ½Ğ° ÑÑ‚Ğ¾Ğ¼ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ"]));
  wrap.appendChild(ss);

  // Total balance
  const bt = el("div",{className:"balance-total"});
  bt.appendChild(el("div",{style:{fontSize:"11px",color:C.sub,letterSpacing:"2px",textTransform:"uppercase",marginBottom:"4px"}},["ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ"]));
  bt.appendChild(el("div",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:"34px",fontWeight:"700",color:tI-tE>=0?C.green:C.red}},[(tI-tE>=0?"+":"")+fmt(tI-tE)]));
  const btsub = el("div",{style:{display:"flex",justifyContent:"center",gap:"18px",marginTop:"8px",fontSize:"13px"}});
  btsub.appendChild(el("span",{style:{color:C.green}},["â†‘ "+fmt(tI)]));
  btsub.appendChild(el("span",{style:{color:C.red}},["â†“ "+fmt(tE)]));
  bt.appendChild(btsub); wrap.appendChild(bt);

  // Account cards
  const ac = el("div",{className:"account-cards"});
  for(const a of ACCOUNTS){
    const inc=entries.filter(e=>e.account===a&&e.type==="income").reduce((s,e)=>s+e.amount,0);
    const exp=entries.filter(e=>e.account===a&&e.type==="expense").reduce((s,e)=>s+e.amount,0);
    const ov=overrides[a]; const d=ov!==undefined?ov:(inc-exp);
    const card = el("div",{className:"account-card"});
    card.appendChild(el("div",{style:{fontSize:"18px",marginBottom:"4px"}},[ICONS[a]]));
    card.appendChild(el("div",{style:{fontSize:"10px",color:C.sub,marginBottom:"4px"}},[a]));
    card.appendChild(el("div",{style:{fontFamily:"'Unbounded',sans-serif",fontSize:"12px",color:d>=0?C.al:C.red,fontWeight:"700",lineHeight:"1.3"}},[fmt(d)]));
    if(ov!==undefined) card.appendChild(el("div",{style:{fontSize:"9px",color:C.amber,marginTop:"3px"}},["âœ± ÑĞºĞ¾Ñ€Ñ€."]));
    ac.appendChild(card);
  }
  wrap.appendChild(ac);

  // Chart
  if(months.length>0){
    const ch = el("div",{className:"card",style:{marginBottom:"14px"}});
    ch.appendChild(el("div",{style:{fontSize:"11px",color:C.sub,letterSpacing:"1px",textTransform:"uppercase",marginBottom:"14px"}},["Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ°"]));
    const bars = el("div",{style:{display:"flex",alignItems:"flex-end",gap:"6px",height:"90px"}});
    for(const m of months){
      const {inc,exp}=byM[m];
      const col = el("div",{style:{flex:"1",display:"flex",flexDirection:"column",alignItems:"center"}});
      const bw = el("div",{style:{display:"flex",gap:"3px",alignItems:"flex-end",height:"82px"}});
      const ib = el("div",{style:{width:"10px",height:Math.max(Math.round((inc/maxV)*80),2)+"px",background:C.green,borderRadius:"3px 3px 0 0",opacity:"0.85"}});
      const eb = el("div",{style:{width:"10px",height:Math.max(Math.round((exp/maxV)*80),2)+"px",background:C.red,borderRadius:"3px 3px 0 0",opacity:"0.85"}});
      bw.appendChild(ib); bw.appendChild(eb); col.appendChild(bw);
      col.appendChild(el("div",{style:{fontSize:"9px",color:C.sub,marginTop:"4px"}},[mLabel(m).slice(0,3)]));
      bars.appendChild(col);
    }
    ch.appendChild(bars);
    const leg = el("div",{style:{display:"flex",gap:"14px",marginTop:"8px",fontSize:"11px",color:C.sub}});
    const li = el("span"); li.appendChild(el("span",{style:{color:C.green}},["â– "])); li.appendChild(document.createTextNode(" Ğ”Ğ¾Ñ…Ğ¾Ğ´")); leg.appendChild(li);
    const le = el("span"); le.appendChild(el("span",{style:{color:C.red}},["â– "])); le.appendChild(document.createTextNode(" Ğ Ğ°ÑÑ…Ğ¾Ğ´")); leg.appendChild(le);
    ch.appendChild(leg); wrap.appendChild(ch);
  }

  // Month table
  if(Object.keys(byM).length>0){
    const mt = el("div",{className:"card",style:{marginBottom:"14px"}});
    mt.appendChild(el("div",{style:{fontSize:"11px",color:C.sub,letterSpacing:"1px",textTransform:"uppercase",marginBottom:"12px"}},["ĞŸĞ¾ Ğ¼ĞµÑÑÑ†Ğ°Ğ¼"]));
    for(const m of Object.keys(byM).sort((a,b)=>b.localeCompare(a))){
      const {inc,exp}=byM[m]; const p=inc-exp;
      const row = el("div",{className:"summary-row"});
      row.appendChild(el("span",{style:{fontSize:"13px",color:"#e2e2f0"}},[mLabel(m)]));
      const rv = el("div",{style:{textAlign:"right"}});
      rv.appendChild(el("div",{style:{fontSize:"12px",color:p>=0?C.green:C.red,fontWeight:"700"}},[(p>=0?"+":"")+fmt(p)]));
      rv.appendChild(el("div",{style:{fontSize:"10px",color:C.sub}},["â†‘"+fmt(inc)+" â†“"+fmt(exp)]));
      row.appendChild(rv); mt.appendChild(row);
    }
    wrap.appendChild(mt);
  }

  // Export
  const expBtn = el("button",{
    style:{width:"100%",padding:"14px",borderRadius:"14px",border:"1.5px solid #2e2e4a",background:"transparent",color:C.al,cursor:"pointer",fontSize:"14px",fontWeight:"600",display:"flex",alignItems:"center",justifyContent:"center",gap:"8px"},
    onclick:()=>doExport(entries,overrides)
  },["ğŸ“¥ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² Excel (CSV)"]);
  wrap.appendChild(expBtn);
  return wrap;
}

function doExport(entries,overrides){
  const byM={};
  for(const e of entries){const k=mKey(e.date);if(!byM[k])byM[k]={inc:0,exp:0};if(e.type==="income")byM[k].inc+=e.amount;else byM[k].exp+=e.amount;}
  const rows=["Ğ”Ğ˜ĞĞĞœĞ˜ĞšĞ ĞŸĞ ĞœĞ•Ğ¡Ğ¯Ğ¦ĞĞœ",["ĞœĞµÑÑÑ†","Ğ”Ğ¾Ñ…Ğ¾Ğ´Ñ‹","Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹","ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ","ĞœĞ°Ñ€Ğ¶Ğ° %"].join(";")];
  let tI=0,tE=0;
  for(const m of Object.keys(byM).sort()){const{inc,exp}=byM[m];tI+=inc;tE+=exp;rows.push([mLabel(m),inc,exp,inc-exp,inc>0?((inc-exp)/inc*100).toFixed(1)+"%":"0%"].join(";"));}
  rows.push(["Ğ˜Ğ¢ĞĞ“Ğ",tI,tE,tI-tE,tI>0?((tI-tE)/tI*100).toFixed(1)+"%":"0%"].join(";"));
  rows.push("","Ğ‘ĞĞ›ĞĞĞ¡Ğ« ĞŸĞ Ğ¡Ğ§Ğ•Ğ¢ĞĞœ",["Ğ¡Ñ‡Ñ‘Ñ‚","ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº","Ğ”Ğ¾Ñ…Ğ¾Ğ´Ñ‹","Ğ Ğ°ÑÑ…Ğ¾Ğ´Ñ‹"].join(";"));
  for(const a of ACCOUNTS){const inc=entries.filter(e=>e.account===a&&e.type==="income").reduce((s,e)=>s+e.amount,0);const exp=entries.filter(e=>e.account===a&&e.type==="expense").reduce((s,e)=>s+e.amount,0);rows.push([a,overrides[a]!==undefined?overrides[a]:(inc-exp),inc,exp].join(";"));}
  rows.push("","Ğ’Ğ¡Ğ• ĞĞŸĞ•Ğ ĞĞ¦Ğ˜Ğ˜",["Ğ”Ğ°Ñ‚Ğ°","Ğ¢Ğ¸Ğ¿","Ğ¡Ñ‡Ñ‘Ñ‚","ĞĞ°Ğ»/Ğ‘ĞµĞ·Ğ½Ğ°Ğ»","ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ","Ğ¡ÑƒĞ¼Ğ¼Ğ°","ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹"].join(";"));
  for(const e of [...entries].sort((a,b)=>new Date(b.date)-new Date(a.date))){rows.push([new Date(e.date).toLocaleDateString("ru-RU"),e.type==="income"?"Ğ”Ğ¾Ñ…Ğ¾Ğ´":"Ğ Ğ°ÑÑ…Ğ¾Ğ´",e.account,e.payType==="cash"?"ĞĞ°Ğ»":"Ğ‘ĞµĞ·Ğ½Ğ°Ğ»",e.category,e.amount,e.comment||""].join(";"));}
  const blob=new Blob(["\uFEFF"+rows.join("\n")],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=`airtime_${new Date().toLocaleDateString("ru-RU").replace(/\./g,"-")}.csv`;a.click();URL.revokeObjectURL(url);
}

// â”€â”€ Nav & Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TABS = [{id:"add",icon:"ï¼‹",label:"Ğ’Ğ½ĞµÑÑ‚Ğ¸"},{id:"history",icon:"â˜°",label:"Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ"},{id:"balances",icon:"âš–",label:"Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ"},{id:"dashboard",icon:"â—ˆ",label:"Ğ˜Ñ‚Ğ¾Ğ³Ğ¸"}];

function renderNav(){
  const nav = document.getElementById("nav");
  nav.innerHTML="";
  for(const t of TABS){
    const btn = el("button",{className:"nav-btn",onclick:()=>setState({tab:t.id})});
    const ic = el("span",{className:"nav-icon"},[t.icon]);
    ic.style.filter = state.tab===t.id?"none":"grayscale(1)";
    ic.style.opacity = state.tab===t.id?"1":"0.35";
    const lb = el("span",{className:"nav-label"},[t.label]);
    lb.style.color = state.tab===t.id?C.al:"#3a3a5a";
    lb.style.fontWeight = state.tab===t.id?"600":"400";
    btn.appendChild(ic); btn.appendChild(lb); nav.appendChild(btn);
  }
}

function render(){
  const content = document.getElementById("content");
  content.innerHTML="";
  const screen = state.tab==="add"?renderAdd():state.tab==="history"?renderHistory():state.tab==="balances"?renderBalances():renderDashboard();
  content.appendChild(screen);
  renderNav();
}

init();
</script>
</body>
</html>
